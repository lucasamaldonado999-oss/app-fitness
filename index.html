<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Grantala</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            /* PALETTE - GREEN FOCUSED */
            --bg-wallpaper: #121212;
            --bg-body: #000000;
            --bg-card: #080808;
            --bg-input: #1c1c1e;
            --bg-header: #000000;
            --bg-modal: #1c1c1e;

            --primary: #32d74b;
            --primary-dark: #208b33;
            --primary-dim: rgba(50, 215, 75, 0.15);

            --text-high: #ffffff;
            --text-med: #8e8e93;
            --text-inv: #000000;

            --border: rgba(255, 255, 255, 0.1);

            --card-shadow: none;
            --header-shadow: none;

            --nav-height: 80px;
            --app-max-width: 430px;
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;

            --radius-xl: 30px;
            --radius-lg: 20px;
            --radius-md: 14px;
        }

        body.light-mode {
            --bg-wallpaper: #f2f2f7;
            --bg-body: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f2f2f7;
            --bg-header: #ffffff;
            --bg-modal: #ffffff;

            --text-high: #1c1c1e;
            --text-med: #48484a;
            --text-inv: #ffffff;

            --border: rgba(0, 0, 0, 0.05);

            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --header-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* WATER OVERRIDE - If user wants "Apenas tons de verde", I'll make water a cyan/teal to not look weird but fit the vibe. */
        .theme-water {
            color: #5ac8fa;
        }

        .bg-water {
            background-color: #5ac8fa;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-high);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        #app-container {
            width: 100%;
            max-width: var(--app-max-width);
            background-color: var(--bg-body);
            min-height: 100vh;
            position: relative;
            padding-bottom: calc(var(--nav-height) + 30px);
            box-shadow: none;
            /* Removed extra shadow */
            display: flex;
            flex-direction: column;
        }

        h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo-dark,
        .logo-light {
            font-family: 'Pacifico', cursive;
            font-size: 1.9rem;
            font-weight: 400;
            letter-spacing: normal;
        }

        .logo-dark {
            color: #fff;
            display: block;
            /* Visible by default (Dark Mode) */
        }

        .logo-light {
            color: #000;
            display: none;
            /* Hidden by default */
        }

        body.light-mode .logo-dark {
            display: none;
        }

        body.light-mode .logo-light {
            display: block;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
        }

        .text-sm {
            font-size: 0.85rem;
        }

        /* HEADER */
        header {
            padding: 20px 20px 5px 20px;
            /* More compact header */
            background: var(--bg-header);
            box-shadow: var(--header-shadow);
            position: sticky;
            top: 0;
            z-index: 50;
            transition: background 0.3s, box-shadow 0.3s;
        }

        header.scrolled {
            background: var(--bg-header);
            opacity: 0.9;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            /* Reduced vertical gap */
        }

        /* DEFINITIVE DATE BTN - POINTER EVENTS NONE ON CHILDREN */
        /* FLAT DATE NAV */
        .date-nav {
            display: flex;
            align-items: center;
            width: 150px;
            /* Fixed total width for layout stability */
            justify-content: space-between;
        }

        .date-btn-wrapper {
            position: relative;
            background: transparent;
            width: 90px;
            /* Fixed zone for labels like 'Amanhã' or '12 Mar' */
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, opacity 0.2s;
        }

        .date-btn-wrapper:active {
            opacity: 0.7;
            transform: scale(0.96);
        }

        .date-text {
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--text-med);
            letter-spacing: -0.5px;
            white-space: nowrap;
            position: relative;
            transition: color 0.3s;
        }

        .date-text.is-today {
            color: #fff;
        }

        .date-text.is-today::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }

        .nav-arrow {
            background: transparent;
            border: none;
            color: var(--text-med);
            cursor: pointer;
            width: 30px;
            /* Fixed zone for arrows */
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.8;
        }

        .nav-arrow:active {
            opacity: 1;
            transform: scale(1.2);
        }

        #date-input-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }

        /* 3. NUTRICIONAL DIÁRIO (FLOATING CARD) */
        #daily-summary-card {
            background: var(--bg-card);
            padding: 35px 24px;
            border: none;
            border-radius: var(--radius-xl);
            box-shadow: var(--card-shadow);
            margin: 0 10px 50px 10px;
            display: block;
        }

        .macro-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border: none;
            padding-bottom: 0px;
        }

        .m-item {
            text-align: center;
            flex: 1;
        }

        .m-val {
            font-size: 1.4rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
            color: var(--text-high);
        }

        .m-lbl {
            font-size: 0.75rem;
            color: var(--text-med);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .sub-row {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .sub-txt {
            font-size: 0.85rem;
            color: var(--text-med);
        }

        .sub-val {
            font-weight: 700;
            color: var(--text-high);
            margin-left: 5px;
        }

        /* VIEWS */
        .view {
            display: none;
            padding: 0 20px;
            flex: 1;
        }

        .view.active {
            display: block;
        }

        /* FLAT DIARY SECTIONS */
        #view-diary .card {
            background: transparent;
            border: none;
            margin-bottom: 40px;
            box-shadow: none;
        }

        #view-diary .card-head {
            padding: 0 0 15px 0;
            border: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #view-diary .item {
            padding: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
        }

        .btn-pill {
            margin: 15px;
            background: var(--bg-input);
            color: var(--primary);
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
        }

        #view-diary .btn-pill {
            margin: 10px 0;
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 12px;
            font-size: 0.9rem;
            color: var(--primary);
            transition: all 0.2s;
        }

        body.light-mode #view-diary .btn-pill {
            background: #ffffff;
            border: 1px solid #cbddec;
            color: #48484a;
        }

        .btn-pill:active {
            background: rgba(50, 215, 75, 0.1);
        }

        /* 4. ÁGUA (PREMIUM THEMED CARD) */
        #view-diary .water-card {
            background: #0b121e;
            /* Deep refined blue */
            border: none;
            margin-top: 40px;
            padding: 25px 20px;
            box-shadow: none;
            position: relative;
            overflow: visible;
            border-radius: var(--radius-lg);
        }

        body.light-mode #view-diary .water-card {
            background: #f0f6fc;
            /* Cold refined light blue */
            border: 1px solid #cbddec;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        #view-diary .water-card::before {
            display: none;
        }

        /* COLLAPSIBLE MEALS */
        .meal-list {
            transition: max-height 0.35s ease, opacity 0.35s ease, margin 0.35s ease;
            max-height: 2500px;
            opacity: 1;
            overflow: hidden;
        }

        .meal-list.closed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .arrow-icon {
            transition: transform 0.3s ease;
            transform: rotate(180deg);
            /* Open (Up) */
        }

        .arrow-icon.closed {
            transform: rotate(0deg);
            /* Closed (Down) */
        }

        .card-head {
            cursor: pointer;
            user-select: none;
        }

        .w-head {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .w-title {
            color: #00d2ff;
            /* Cyan Neon */
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
        }

        .w-val-text {
            color: var(--text-med);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .w-bar-bg {
            height: 10px;
            /* SYNC W/ CALORIE BAR */
            background: rgba(29, 53, 87, 0.4);
            border-radius: 6px;
            /* Matched Radius */
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid rgba(29, 53, 87, 0.3);
            position: relative;
            z-index: 1;
        }

        body.light-mode .w-bar-bg {
            background: #e2eaf0;
            border: 1px solid #ccdcea;
        }

        .w-bar {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00aaff);
            /* Vibrant but sophisticated blue */
            width: 0%;
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.2);
        }

        body.light-mode .w-bar {
            background: linear-gradient(90deg, #007aff, #4dabf7);
            box-shadow: 0 0 8px rgba(0, 122, 255, 0.15);
        }

        .w-ctrls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .btn-w-quick {
            flex: 1;
            background: #14213d;
            /* Night blue button */
            color: #f1faee;
            border: 1px solid rgba(69, 123, 157, 0.3);
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        body.light-mode .btn-w-quick {
            background: #ffffff;
            color: #3e5c76;
            border: 1px solid #cbddec;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .btn-w-quick:active {
            background: #1d3557;
            transform: scale(0.98);
        }

        body.light-mode .btn-w-quick:active {
            background: #f0f6fc;
            border-color: #3e5c76;
        }

        .w-manual {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .btn-circle {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }

        .btn-circle:active {
            transform: scale(0.92);
        }

        .btn-rem {
            background: rgba(255, 69, 58, 0.1);
            color: #ff453a;
            border: 1px solid rgba(255, 69, 58, 0.2);
        }

        .btn-rem:active {
            background: rgba(255, 69, 58, 0.2);
        }

        .btn-add {
            background: #14213d;
            color: #f1faee;
            border: 1px solid rgba(69, 123, 157, 0.4);
        }

        body.light-mode .btn-add {
            background: #ffffff;
            color: #3e5c76;
            border: 1px solid #cbddec;
        }

        .btn-add:active {
            background: #1d3557;
        }

        body.light-mode .btn-add:active {
            background: #f0f6fc;
        }

        .inp-w {
            flex: 1;
            background: #0d1b2a;
            border: 1px solid rgba(65, 90, 119, 0.3);
            border-radius: 14px;
            color: #f1faee;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 12px;
            outline: none;
            height: 50px;
        }

        body.light-mode .inp-w {
            background: #ffffff;
            border: 1px solid #cbddec;
            color: #1c1c1e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .inp-w:focus {
            border-color: #457b9d;
            box-shadow: 0 0 0 3px rgba(69, 123, 157, 0.2);
        }

        body.light-mode .inp-w:focus {
            border-color: #3e5c76;
            box-shadow: 0 0 0 3px rgba(62, 92, 118, 0.1);
        }

        body.light-mode .btn-w-quick,
        body.light-mode .inp-w {
            background: #ffffff;
            border: 1px solid #d1d1d6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        body.light-mode .btn-circle.btn-add {
            background: rgba(0, 122, 255, 0.1);
            border-color: rgba(0, 122, 255, 0.2);
        }

        .inp-w::placeholder {
            color: rgba(10, 132, 255, 0.4);
            font-weight: 500;
            font-size: 1rem;
        }


        /* 5. RECEITAS */
        .rec-grid {
            display: grid;
            gap: 15px;
            padding-bottom: 80px;
        }

        .rec-item {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
        }

        .rec-thumb {
            width: 70px;
            height: 70px;
            border-radius: 14px;
            background-color: var(--bg-input);
            background-size: cover;
            background-position: center;
        }

        /* 6. TREINO */
        /* 6. TREINO */
        .day-grid {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap !important;
            /* FORCE NO WRAP */
            overflow-x: auto;
            gap: 5px;
            /* Reduced gap to fit */
            padding: 5px 2px 15px 2px;
            /* Minimal padding */
            margin-bottom: 20px;
            justify-content: space-between;
            /* Distribute evenly */
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            white-space: nowrap;
        }

        .day-grid::-webkit-scrollbar {
            display: none;
        }

        .day-chip {
            flex: 1;
            /* Allow slight flex to fill if needed */
            min-width: 42px;
            /* Ultra Compact to fit 7 days in 360px */
            background: var(--bg-input);
            color: var(--text-med);
            padding: 12px 0;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .day-chip.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            box-shadow: 0 2px 10px rgba(50, 215, 75, 0.3);
            transform: translateY(-2px);
        }

        /* 7. PERFIL */
        .prof-head {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .prof-av {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--bg-input);
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .prof-name {
            background: transparent;
            border: none;
            color: var(--text-high);
            font-size: 1.6rem;
            font-weight: 800;
            text-align: center;
            width: 100%;
            outline: none;
        }

        #view-profile .tmb-box {
            background: #080808;
            /* Ultra-dark floating gray */
            padding: 24px;
            border: none;
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            margin-bottom: 30px;
        }

        body.light-mode #view-profile .tmb-box {
            background: #ffffff;
            box-shadow: var(--card-shadow);
        }

        #view-profile .tmb-h {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-high);
            letter-spacing: -0.5px;
            margin-bottom: 15px;
            border: none;
            padding: 0;
            text-transform: none;
        }

        #view-profile .tmb-res {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 20px 0;
            text-align: left;
            margin-top: 20px;
        }

        #view-profile .inp-std {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 14px;
            color: var(--text-high);
        }

        body.light-mode #view-profile .inp-std {
            background: #f2f2f7;
            border-bottom: 1px solid #d1d1d6;
        }

        .tmb-big {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .btn-expand {
            width: 100%;
            background: #080808;
            border: 1px solid var(--border);
            color: var(--text-high);
            padding: 18px;
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin-bottom: 20px;
        }

        body.light-mode .btn-expand {
            background: #ffffff;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .btn-expand:active {
            transform: scale(0.98);
            background: #121212;
        }

        body.light-mode .btn-expand:active {
            background: #f2f2f7;
        }

        .btn-expand .arrow-icon {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 0.5;
        }

        .btn-expand.active .arrow-icon {
            transform: rotate(180deg);
            opacity: 1;
            color: var(--primary);
        }

        .measures-collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s;
            opacity: 0;
        }

        .measures-collapse.open {
            max-height: 1200px;
            opacity: 1;
            margin-bottom: 30px;
        }

        /* BODY MEASUREMENTS GUIDE */
        .body-measure-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: start;
            /* Aligned top to match inputs */
            gap: 15px;
            width: 100%;
            margin-top: 10px;
        }

        .body-sketch-container {
            width: 160px;
            /* Default desktop size */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .body-sketch-img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.15));
        }

        .measure-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .measure-col.left-col {
            text-align: right;
        }

        .measure-col.right-col {
            text-align: left;
        }

        .measure-item-guide {
            margin-bottom: 0;
        }

        .measure-item-guide .lbl-sm {
            display: block;
            margin-bottom: 4px;
            font-size: 0.70rem;
            color: var(--text-med);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .measure-item-guide .inp-std {
            width: 100% !important;
            text-align: center;
            font-weight: 700;
            padding: 10px;
            /* Reduced padding */
            font-size: 0.9rem;
        }

        @media (max-width: 480px) {
            .body-measure-grid {
                display: grid !important;
                /* 3 columns: inputs - avatar - inputs */
                /* Center column fixed width to ensure avatar visibility */
                grid-template-columns: 1fr 150px 1fr !important;
                gap: 5px !important;
                align-items: start !important;
                /* Align to top to prevent vertical centering issues */
            }

            .body-sketch-container {
                position: relative !important;
                width: 100% !important;
                height: 480px !important;
                /* Explicit fixed height prevents collapse */
                display: block !important;
                margin: 0 auto !important;
                /* Ensure it doesn't overlap inputs */
            }

            .body-sketch-img {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
                display: block !important;
            }

            /* Ensure SVG guides overlay correctly */
            #body-guide-svg {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 5 !important;
            }

            .measure-col {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                gap: 12px !important;
                /* Better spacing between inputs */
                padding: 10px 0 !important;
            }

            /* Restore standard input styling, do not shrink them too much */
            .measure-item-guide .inp-std {
                width: 100% !important;
                padding: 8px 4px !important;
                font-size: 0.9rem !important;
                text-align: center !important;
            }

            .measure-item-guide .lbl-sm {
                font-size: 0.75rem !important;
                margin-bottom: 2px !important;
                display: block !important;
                white-space: normal !important;
                /* Allow wrapping if needed */
            }
        }



        /* Highlight flash for inputs */
        @keyframes highlight-flash {
            0% {
                box-shadow: 0 0 0 0 var(--primary);
                border-color: var(--primary);
            }

            100% {
                box-shadow: 0 0 20px 0 transparent;
                border-color: rgba(255, 255, 255, 0.1);
            }
        }

        .highlight-flash {
            animation: highlight-flash 1s ease-out;
        }

        /* NAV */
        nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: var(--app-max-width);
            background: var(--bg-header);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border, rgba(255, 255, 255, 0.1));
            display: flex;
            height: var(--nav-height);
            z-index: 100;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: var(--header-shadow);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .nav-it {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-high);
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s, color 0.2s;
        }

        .nav-it.active {
            opacity: 1;
            color: var(--primary);
        }

        .n-ic {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .n-lb {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* MODALS */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.open {
            display: flex;
            animation: fadeIn 0.2s;
        }

        .sheet {
            background: #1c1c1e;
            width: 100%;
            max-width: var(--app-max-width);
            border-radius: 24px 24px 0 0;
            padding: 30px 25px 50px 25px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .inp-std {
            width: 100%;
            box-sizing: border-box;
            /* Fix for mobile overflow */
            background: #2c2c2e;
            border: 1px solid transparent;
            padding: 14px;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .inp-std:focus {
            border-color: var(--primary);
            outline: none;
        }

        .lbl-sm {
            color: var(--text-med);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 6px;
            display: block;
        }

        .fab {
            background: var(--primary);
            color: #000;
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            border-radius: 40px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            z-index: 90;
            box-shadow: 0 4px 20px rgba(50, 215, 75, 0.4);
            border: none;
        }

        /* PREMIUM SUMMARY REDESIGN */
        .sum-box {
            margin-bottom: 0;
        }

        .sum-cal-row {
            margin-bottom: 25px;
            text-align: left;
        }

        .sum-cal-val {
            font-size: 2.0rem;
            font-weight: 800;
            color: var(--text-high);
            letter-spacing: -1px;
            line-height: 1;
        }

        .sum-cal-lbl {
            font-size: 0.9rem;
            color: var(--text-med);
            margin-left: 5px;
            font-weight: 500;
        }

        .sum-diff {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
            display: block;
        }

        .p-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }

        body.light-mode .p-track {
            background: rgba(0, 0, 0, 0.08);
        }

        .p-track.lg {
            height: 10px;
            border-radius: 6px;
        }

        .p-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .p-fill.cal {
            background: linear-gradient(90deg, var(--primary), #aaffa0);
        }

        .p-fill.prot {
            background: #0a84ff;
        }

        .p-fill.carb {
            background: #ff9f0a;
        }

        .p-fill.fat {
            background: #bf5af2;
        }

        .p-fill.exc {
            background: #ff453a;
        }

        /* Exceeded */

        .macro-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .n-row {
            display: flex;
            flex-direction: column;
        }

        .n-head {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-high);
            margin-bottom: 2px;
        }

        .n-det {
            font-size: 0.7rem;
            color: var(--text-med);
            font-weight: 400;
        }

        .micro-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border-top: none;
            padding-top: 15px;
        }

        .micro-item {
            display: flex;
            flex-direction: column;
        }

        .micro-lbl {
            font-size: 0.7rem;
            color: var(--text-med);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .micro-val {
            font-size: 0.85rem;
            color: var(--text-high);
            font-weight: 600;
        }

        /* SEARCH ICON MODERNIZATION */
        .search-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .search-wrapper .search-icon {
            position: absolute;
            left: 14px;
            top: 52%;
            transform: translateY(-50%);
            color: var(--text-med);
            pointer-events: none;
            opacity: 0.5;
        }

        .search-wrapper .inp-std {
            padding-left: 44px;
            margin-bottom: 0;
        }

        /* CUSTOM FOOD LIST */
        .food-list-container {
            max-height: 280px;
            overflow-y: auto;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .food-opt {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .food-opt:last-child {
            border-bottom: none;
        }

        .food-opt:active {
            background: var(--primary-dim);
        }

        .food-opt.selected {
            background: var(--primary-dim);
            color: var(--primary);
        }

        .f-opt-name {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .f-opt-num {
            font-size: 0.7rem;
            color: var(--text-med);
            opacity: 0.5;
            font-weight: 700;
        }

        /* UNIFIED SETTINGS CARD */
        #btn-settings {
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            z-index: 2;
        }

        #btn-settings.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            margin-bottom: 0;
            border-bottom: none;
            /* REMOVED DIVIDER */
            padding-bottom: 20px;
            /* Slight optical adjustment */
        }

        body.light-mode #btn-settings.active {
            border-bottom: none;
        }

        #settings-container.open {
            margin-top: 0;
            border: 1px solid var(--border);
            border-top: none;
            /* NO TOP BORDER */
            background: #080808;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
            padding: 10px 0 0 0;
            /* SPACE ONLY, NO LINE */
            margin-bottom: 30px;
            box-shadow: none;
        }

        body.light-mode #settings-container.open {
            background: #ffffff;
            box-shadow: var(--card-shadow);
        }

        /* Unified Settings Inner */
        #settings-container .tmb-box {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 10px 20px 25px 20px !important;
            border-radius: 0 !important;
        }

        /* UNIFIED MEASURES CARD */
        #btn-measures {
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            z-index: 2;
        }

        #btn-measures.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 20px;
        }

        body.light-mode #btn-measures.active {
            border-bottom: none;
        }

        #measures-container.open {
            margin-top: 0;
            border: 1px solid var(--border);
            border-top: none;
            background: #080808;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
            padding: 10px 0 0 0;
            margin-bottom: 30px;
            box-shadow: none;
        }

        body.light-mode #measures-container.open {
            background: #ffffff;
            box-shadow: var(--card-shadow);
        }

        /* Unified Measures Inner */
        #measures-container .tmb-box {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 10px 15px 25px 15px !important;
            border-radius: 0 !important;
        }

        /* REFINED HYDRATION (PREMIUM DARK MODE) */
        body:not(.light-mode) .water-card {
            background: #080808 !important;
            /* Premium Black */
            border: 1px solid var(--border);
            /* Standard Border */
            box-shadow: none;
        }

        body:not(.light-mode) .btn-w-quick {
            background: #0A0A0A !important;
            /* Premium Ultra Dark */
            color: #00d2ff !important;
            /* Match Title Cyan */
            border-color: #1A1A1A !important;
            /* Subtle Dark Border */
        }

        body:not(.light-mode) .inp-w {
            background: #0A0A0A !important;
            /* Premium Ultra Dark */
            border-color: #1A1A1A !important;
            color: #00d2ff !important;
        }

        body:not(.light-mode) .btn-add {
            background: rgba(0, 210, 255, 0.1) !important;
            /* Premium Blue Glass */
            color: #00d2ff !important;
            /* Vibrant Cyan */
            border-color: rgba(0, 210, 255, 0.2) !important;
            /* Blue Border */
        }

        /* Bar Background - Deep Navy Premium Track */
        body:not(.light-mode) .w-bar-bg {
            background: rgba(0, 20, 50, 0.6) !important;
            /* Premium Deep Navy Glass */
            border-color: rgba(0, 20, 50, 0.4) !important;
        }

        /* Ensure title matches if needed (it already does) */
        /* FAVORITES STAR */
        .fav-star {
            color: #333;
            /* Default gray */
            font-size: 1.2rem;
            margin-right: 10px;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }

        .fav-star.active {
            color: #FFD700;
            /* Gold */
            transform: scale(1.1);
        }

        /* Filter Toggle Button */
        .fav-toggle-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-med);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .fav-toggle-btn.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: #FFD700;
            color: #FFD700;
        }

        /* New Control Bar for Favorites */
        .fav-control-bar {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-filter {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-med);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-filter.active {
            background: var(--primary-dim);
            border-color: var(--primary);
            color: var(--primary);
        }

        .nutri-bar-row {
            margin-bottom: 12px;
        }

        .nutri-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--text-med);
        }

        .nutri-val {
            color: var(--text-main);
            font-weight: 600;
        }

        #body-guide-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .guide-line {
            stroke: #000;
            stroke-width: 2;
            stroke-dasharray: 4 2;
            /* Dotted effect */
            opacity: 0.8;
        }

        .guide-circle {
            fill: #000;
        }

        @media (max-width: 480px) {
            .body-sketch-container {
                min-height: 350px;
            }
        }
    </style>
</head>

<body>


    <div id="app-container">

        <header>
            <div class="header-top">
                <h1 class="logo-dark">Grantala</h1>
                <h1 class="logo-light">Grantala</h1>
                <div class="date-nav">
                    <button class="nav-arrow" onclick="changeDate(-1)">
                        <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                            <path d="M7 1L1 7L7 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="date-btn-wrapper" onclick="openDatePicker()">
                        <div class="date-btn-content">
                            <span id="date-text">Hoje</span>
                        </div>
                        <input type="date" id="date-input-hidden" onchange="onDateChange(this.value)">
                    </div>
                    <button class="nav-arrow" onclick="changeDate(1)">
                        <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                            <path d="M1 1L7 7L1 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>

        </header>

        <main>
            <!-- DIARY -->
            <div id="view-diary" class="view">
                <div id="daily-summary-card">
                    <!-- CONTENT GENERATED BY JS -->
                </div>
                <div id="meals-container"></div>

                <!-- 4. WATER CARD (BLUE THEME) -->
                <div class="water-card">
                    <div class="w-head">
                        <div class="w-title">
                            <span style="font-size:1.3rem;">💧</span> HIDRATAÇÃO
                        </div>
                        <span id="w-val" class="w-val-text">0 / 2000 ml</span>
                    </div>
                    <div class="w-bar-bg">
                        <div id="w-bar" class="w-bar"></div>
                    </div>

                    <div class="w-ctrls">
                        <button class="btn-w-quick" onclick="addWater(250)">+ 250ml</button>
                        <button class="btn-w-quick" onclick="addWater(500)">+ 500ml</button>
                    </div>

                    <div class="w-manual">
                        <button class="btn-circle btn-rem" onclick="manualWater(-1)">-</button>
                        <input type="number" id="w-inp" class="inp-w" placeholder="ml">
                        <button class="btn-circle btn-add" onclick="manualWater(1)">+</button>
                    </div>
                </div>
            </div>

            <!-- 5. RECIPES -->
            <div id="view-recipes" class="view">
                <div id="rec-list" class="rec-grid"></div>
                <button class="fab" onclick="openRecModal()">+ Nova Receita</button>
            </div>

            <!-- 6. WORKOUT -->
            <div id="view-workout" class="view">
                <div id="day-scroller" class="day-grid"></div>
                <div id="work-list" class="card" style="padding: 20px; text-align: center; color: var(--text-med);">
                </div>
                <div class="btn-pill" onclick="openExModal()">+ Adicionar Exercício</div>
            </div>

            <!-- 7. PROFILE -->
            <div id="view-profile" class="view">
                <div class="prof-head">
                    <input type="file" id="p-av-file" style="display:none" onchange="upAv(this)">
                    <div class="prof-av" id="p-av" onclick="document.getElementById('p-av-file').click()">
                        <span style="font-size:2rem; opacity:0.5;">📷</span>
                    </div>
                    <input type="text" id="p-name" class="prof-name" placeholder="Seu Nome" onchange="saveProf()">
                </div>

                <div class="tmb-box">
                    <div class="tmb-h">Taxa Metabólica Basal (TMB)</div>
                    <p style="font-size:0.85rem; color:var(--text-med); margin-bottom:20px; line-height:1.4;">
                        A TMB é a quantidade de calorias que seu corpo gasta por dia apenas para manter as funções
                        vitais, mesmo sem realizar atividades físicas.
                    </p>
                    <div id="tmb-msg"
                        style="margin-bottom: 15px; font-size: 0.85rem; padding: 10px; border-radius: var(--radius-sm); display: none;">
                    </div>

                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1;"><span class="lbl-sm">Peso (kg)</span><input type="number" id="p-w"
                                class="inp-std" placeholder="00.0" min="20" max="500" onchange="calcTMB()"></div>
                        <div style="flex:1;"><span class="lbl-sm">Altura (cm)</span><input type="number" id="p-h"
                                class="inp-std" placeholder="000" min="50" max="260" onchange="calcTMB()"></div>
                    </div>

                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1;"><span class="lbl-sm">Idade</span><input type="number" id="p-age"
                                class="inp-std" placeholder="00" min="13" max="120" onchange="calcTMB()"></div>
                        <div style="flex:1;"><span class="lbl-sm">Sexo</span><select id="p-sex" class="inp-std"
                                onchange="calcTMB()">
                                <option value="m">Homem</option>
                                <option value="f">Mulher</option>
                            </select></div>
                    </div>

                    <div><span class="lbl-sm">Nível de Atividade Física</span>
                        <select id="p-act" class="inp-std" onchange="calcTMB()">
                            <option value="1.2">Sedentário (TMB x 1,2)</option>
                            <option value="1.375">Levemente ativo (TMB x 1,375)</option>
                            <option value="1.55">Moderadamente ativo (TMB x 1,55)</option>
                            <option value="1.725">Muito ativo (TMB x 1,725)</option>
                        </select>
                    </div>


                    <div style="margin-top:10px;"><span class="lbl-sm">Objetivo do Usuário</span>
                        <select id="p-goal" class="inp-std" onchange="calcTMB()">
                            <option value="0">Manter peso (TMB x Atividade)</option>
                            <option value="-0.15">Perder peso (-15% kcal)</option>
                            <option value="0.15">Ganhar peso (+15% kcal)</option>
                        </select>
                    </div>

                    <div class="tmb-res">
                        <!-- 1. BASAL PURE -->
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span class="lbl-sm" style="margin:0;">Metabolismo Basal</span>
                            <span style="font-weight:700; color:var(--text-high);"><span id="tmb-base">0</span>
                                kcal</span>
                        </div>



                        <!-- 3. GOAL (Target) -->
                        <div style="padding-top:5px;">
                            <span id="tmb-goal-lbl" class="lbl-sm"
                                style="color:var(--primary); display:block; text-align:center;">Sua Meta Diária
                                (Objetivo)</span>
                            <div class="tmb-big" id="tmb-res">0 kcal</div>
                        </div>
                    </div>
                </div>

                <!-- 8. BOTÃO EXPANDIR MEDIDAS -->
                <button id="btn-measures" class="btn-expand" onclick="toggleMeasures(this)">
                    <span>Medidas Corporais</span>
                    <svg class="arrow-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>

                <!-- 8. MEDIDAS CORPORAIS CONTAINER -->
                <div id="measures-container" class="measures-collapse">
                    <div class="tmb-box" style="margin-top: 5px; padding: 20px 15px;">

                        <!-- NEW PREMIUM DASHBOARD LAYOUT -->
                        <div class="body-measure-grid" style="align-items:start;">

                            <!-- COL 1: UPPER BODY (Left) -->
                            <div class="measure-col left-col">
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Pescoço</span>
                                    <input type="number" id="m-neck" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Ombro</span>
                                    <input type="number" id="m-shoulder" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Peitoral</span>
                                    <input type="number" id="m-chest" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div style="height:10px;"></div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Braço Esq.</span>
                                    <input type="number" id="m-arm-l" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Braço Dir.</span>
                                    <input type="number" id="m-arm-r" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Antebraço E.</span>
                                    <input type="number" id="m-forearm-l" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Antebraço D.</span>
                                    <input type="number" id="m-forearm-r" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                            </div>

                            <!-- COL 2: VISUAL CENTER -->
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <button class="btn-pill-sm" onclick="toggleBodyView()"
                                    style="background:var(--bg-input); border:1px solid var(--border); color:var(--text-med); font-size:0.75rem; padding:6px 16px; margin-bottom:15px; width:140px;">
                                    🔄 Girar
                                </button>
                                <div class="body-sketch-container">
                                    <svg id="body-guide-svg" viewBox="0 0 160 400">
                                        <g id="static-guides-container"></g>
                                        <line id="guide-line-obj" class="guide-line" x1="0" y1="0" x2="160" y2="0">
                                        </line>
                                        <circle id="guide-circle-left" class="guide-circle" cx="10" cy="0" r="3">
                                        </circle>
                                        <circle id="guide-circle-right" class="guide-circle" cx="150" cy="0" r="3">
                                        </circle>
                                    </svg>
                                    <img id="body-anatomy-img" src="" style="width:100%; display:block;"
                                        alt="Body Anatomy">
                                </div>
                            </div>

                            <!-- COL 3: LOWER BODY (Right) -->
                            <div class="measure-col right-col">
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Cintura</span>
                                    <input type="number" id="m-waist" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Quadril</span>
                                    <input type="number" id="m-hip" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div style="height:10px;"></div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Perna Esq.</span>
                                    <input type="number" id="m-thigh-l" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Perna Dir.</span>
                                    <input type="number" id="m-thigh-r" class="inp-std" placeholder="00"
                                        onfocus="showGuide(this.id)" onblur="hideGuide()" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Pant. Esq.</span>
                                    <input type="number" id="m-calf-l" class="inp-std" placeholder="00"
                                        onfocus="setBodyView('back')" onchange="saveMeasures()">
                                </div>
                                <div class="measure-item-guide">
                                    <span class="lbl-sm">Pant. Dir.</span>
                                    <input type="number" id="m-calf-r" class="inp-std" placeholder="00"
                                        onfocus="setBodyView('back')" onchange="saveMeasures()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 9. CONFIGURAÇÕES COLLAPSIBLE -->
                <button id="btn-settings" class="btn-expand" onclick="toggleSettings(this)">
                    <span>Configurações</span>
                    <svg class="arrow-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div id="settings-container" class="measures-collapse">
                    <div class="tmb-box" style="margin-top: 5px; padding: 25px 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:600; font-size:1rem; color:var(--text-high);">Tema do
                                Aplicativo</span>
                            <div class="theme-switch-container" onclick="toggleTheme()"
                                style="background:var(--bg-input); padding:4px; border-radius:50px; display:flex; cursor:pointer; width:120px; position:relative;">
                                <div id="theme-pill-settings"
                                    style="position:absolute; background:var(--primary); width:58px; height:32px; border-radius:40px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); left:4px; top:4px;">
                                </div>
                                <div
                                    style="flex:1; text-align:center; z-index:1; font-size:10px; font-weight:800; color:var(--text-inv); line-height:32px; pointer-events:none;">
                                    DARK</div>
                                <div
                                    style="flex:1; text-align:center; z-index:1; font-size:10px; font-weight:800; color:var(--text-high); line-height:32px; pointer-events:none;">
                                    LIGHT</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- NUTRITIONAL DETAIL PAGE (FULL SCREEN) -->
        <!-- Hidden by default, managed by view state (st.v) -->
        <div id="nutri-detail-page" style="display:none; padding:15px 5px; animation: fadeIn 0.3s ease;">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button class="btn-circle" onclick="closeNutriDetail()"
                    style="margin-right:15px; background:var(--bg-input); color:var(--text-high);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5" />
                        <path d="M12 19l-7-7 7-7" />
                    </svg>
                </button>
                <div>
                    <h2 style="margin:0; font-size:1.5rem;">Nutrição Completa</h2>
                    <span style="font-size:0.85rem; color:var(--text-med);">Detalhamento de Micronutrientes</span>
                </div>
            </div>

            <div id="nutri-detail-list">
                <!-- DYNAMIC CONTENT -->
            </div>
        </div>

        <nav>
            <div class="nav-it active" onclick="go('diary')"><span class="n-ic">🍽️</span><span
                    class="n-lb">Diário</span></div>
            <div class="nav-it" onclick="go('recipes')"><span class="n-ic">📖</span><span class="n-lb">Receitas</span>
            </div>
            <div class="nav-it" onclick="go('workout')"><span class="n-ic">💪</span><span class="n-lb">Treino</span>
            </div>
            <div class="nav-it" onclick="go('profile')"><span class="n-ic">👤</span><span class="n-lb">Perfil</span>
            </div>
        </nav>
    </div>

    <!-- MODALS -->
    <div id="m-food" class="modal" onclick="closeM()">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:15px;">Adicionar Alimento</h2>
            <div class="search-wrapper">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="f-search" class="inp-std" placeholder="Buscar alimento..."
                    oninput="renderFList(this.value)">
            </div>

            <!-- BOTÕES DE FILTRO (FAVORITOS / RECENTES) -->
            <div class="filter-row">
                <button id="btn-mode-fav" class="btn-filter" onclick="toggleListMode('fav')">
                    <span>⭐</span> Favoritos
                </button>
                <button id="btn-mode-rec" class="btn-filter" onclick="toggleListMode('rec')">
                    <span>🕒</span> Recentes
                </button>
            </div>

            <div id="f-list" class="food-list-container"></div>

            <!-- UNIT TOGGLE UI -->
            <div id="unit-area" style="margin-bottom:15px; display:none;">
                <div
                    style="background:rgba(255,255,255,0.05); padding:5px; border-radius:12px; display:flex; gap:5px; overflow-x:auto;">
                    <button id="btn-u-g" class="btn-pill"
                        style="flex:1; padding:8px 4px; font-size:0.8rem; border:1px solid var(--border);"
                        onclick="setU('g')">g</button>
                    <button id="btn-u-ml" class="btn-pill"
                        style="flex:1; padding:8px 4px; font-size:0.8rem; border:1px solid var(--border); display:none;"
                        onclick="setU('ml')">ml</button>
                    <button id="btn-u-c" class="btn-pill"
                        style="flex:1; padding:8px 4px; font-size:0.8rem; border:1px solid var(--border); display:none;"
                        onclick="setU('c')">Copo</button>
                    <button id="btn-u-u" class="btn-pill"
                        style="flex:1; padding:8px 4px; font-size:0.8rem; border:1px solid var(--border); display:none;"
                        onclick="setU('u')">Unid</button>
                </div>
                <div id="u-desc" style="font-size:0.75rem; color:var(--text-med); text-align:center; margin-top:8px;">
                    <span id="u-info"></span>
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="f-g" class="inp-std" value="100" placeholder="Qtd">
                <span id="f-unit-lbl"
                    style="font-weight:700; color:var(--text-med); min-width:35px; text-align:center;">g</span>
            </div>

            <button class="btn-pill" style="width:100%; margin:10px 0; background:var(--primary); color:#000;"
                onclick="addF()">Confirmar</button>
        </div>
    </div>

    <div id="m-rec" class="modal" onclick="closeM()">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2>Nova Receita</h2><br>
            <input type="file" id="r-pic-in" style="display:none" onchange="upRI(this)">
            <div id="r-prev"
                style="width:100%; height:120px; background:#2c2c2e; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover; background-position:center; margin-bottom:15px;"
                onclick="document.getElementById('r-pic-in').click()">+ Foto</div>

            <input id="r-name" class="inp-std" placeholder="Nome da receita">

            <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; margin-bottom:15px;">
                <span class="lbl-sm">Ingredientes:</span>
                <div id="r-ing-box" style="color:#fff; font-size:0.9rem;"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <select id="r-isel" class="inp-std" style="flex:2">
                    <option value="">Alimento...</option>
                </select>
                <input type="number" id="r-iq" class="inp-std" style="flex:1" placeholder="g">
            </div>
            <button class="btn-pill" style="width:100%; margin:10px 0; padding:10px;" onclick="pushRI()">+ Incluir
                Ingrediente</button>

            <button class="btn-pill" style="width:100%; background:var(--primary); color:#000; margin-top:20px;"
                onclick="saveR()">Salvar Receita</button>
        </div>
    </div>

    <div id="m-ex" class="modal" onclick="closeM()">
        <div class="sheet" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:15px;">Exercício</h2>

            <!-- SEARCH & FILTERS -->
            <div class="search-wrapper">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input id="e-search" class="inp-std" placeholder="Pesquisar exercício..."
                    oninput="renderEList(this.value)">
            </div>

            <!-- FILTER BUTTONS (Fav/Rec) -->
            <div class="filter-row">
                <button id="btn-mode-ex-fav" class="btn-filter" onclick="toggleExListMode('fav')">
                    <span>⭐</span> Favoritos
                </button>
                <button id="btn-mode-ex-rec" class="btn-filter" onclick="toggleExListMode('rec')">
                    <span>🕒</span> Recentes
                </button>
            </div>

            <!-- EXERCISE LIST CONTAINER -->
            <div id="e-list" class="food-list-container"
                style="max-height:280px; overflow-y:auto; margin-bottom:12px; border:1px solid var(--border); border-radius:12px;">
            </div>

            <!-- SELECTED EXERCISE DISPLAY (Optional but helpful context) -->
            <div id="e-sel-display"
                style="padding:10px; background:var(--bg-2); border-radius:8px; margin-bottom:10px; display:none; font-weight:bold; color:var(--primary);">
                Selecionado: <span id="e-sel-name">...</span>
            </div>

            <div style="display:flex; gap:10px;">
                <input id="e-s" class="inp-std" placeholder="Séries" type="number">
                <input id="e-r" class="inp-std" placeholder="Reps" type="number">
                <input id="e-kg" class="inp-std" placeholder="Carga (kg)" type="number">
            </div>
            <button class="btn-pill" style="width:100%; background:var(--primary); color:#000; margin-top:10px;"
                onclick="addEx()">Adicionar ao Treino</button>
        </div>
    </div>



    <script>
        const IMG_BODY_FRONT = "assets/body_front.png";
        const IMG_BODY_BACK = "assets/body_back.png";

        let DB_F = [];

        // Function to load food database
        async function loadFoodDatabase() {
            try {
                const response = await fetch('data/alimentos.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                DB_F = await response.json();
                console.log(`Food database loaded: ${DB_F.length} items`);

                // Initialize dependent components here if needed
                // For example, if you have a function that renders the food list, call it here.
                // renderFoodList(); // Example

            } catch (error) {
                console.error("Could not load food database:", error);
                alert("Erro ao carregar banco de dados de alimentos. Verifique se o arquivo data/alimentos.json existe.");
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadFoodDatabase();
        });










        const DB_E = {
            "Peito": [
                "Supino Reto", "Supino Inclinado", "Supino Declinado", "Supino com Halteres", "Crucifixo Reto (Halteres)",
                "Peck Deck (Voador)", "Flexão de Braço", "Supino Máquina", "Crossover Polia Alta", "Crossover Polia Baixa",
                "Pullover", "Supino Inclinado com Halteres", "Supino Declinado com Halteres", "Crucifixo Inclinado",
                "Crucifixo Declinado", "Crucifixo Máquina", "Flexão Diamante", "Flexão Declinada", "Flexão Inclinada",
                "Flexão Explosiva", "Flexão Arqueira", "Chest Press", "Squeeze Press", "Pullover com Halter",
                "Pullover na Polia", "Supino Vertical Máquina", "Supino Articulado", "Cross Over Médio",
                "Flexão com Palmada", "Mergulho nas Paralelas (Foco Peito)", "Supino Floor Press", "Supino Guillotine"
            ],
            "Costas": [
                "Remada", "Puxada", "Levantamento Terra (Deadlift)", "Barra Fixa", "Remada Baixa", "Encolhimento",
                "Puxada Triângulo", "Remada Curvada", "Remada Unilateral (Serrote)", "Remada Cavalinho", "Voador Inverso",
                "Puxada Frente", "Puxada Neutra", "Puxada Supinada", "Puxada Alta Articulada", "Remada Articulada",
                "Remada Máquina", "Remada Curvada Supinada", "Remada Yates", "Remada Pendlay", "Remada Meadows",
                "Remada Kroc", "Puxada Unilateral", "Pulldown", "Rack Pull", "Levantamento Terra Romeno",
                "Levantamento Terra Sumô", "Good Morning", "Hiperextensão Lombar", "Barra Fixa Supinada (Chin Up)",
                "Barra Fixa Neutra", "Meio-Terra", "Remada com Elástico", "Face Pull (Foco Trapézio)"
            ],
            "Ombros": [
                "Desenvolvimento", "Desenvolvimento com Halteres", "Desenvolvimento Máquina", "Elevação Lateral",
                "Crucifixo Inverso", "Arnold Press", "Elevação Frontal", "Elevação Frontal com Barra",
                "Elevação Frontal com Halteres", "Remada Alta", "Face Pull", "Manguito Rotador",
                "Desenvolvimento Militar", "Desenvolvimento Arnold", "Desenvolvimento Articulado", "Desenvolvimento Smith",
                "Elevação Lateral na Polia", "Elevação Lateral Unilateral", "Elevação Lateral Sentado", "Elevação Lateral Inclinada",
                "Elevação Frontal na Polia", "Elevação Frontal com Corda", "Elevação Frontal com Anilha",
                "Crucifixo Inverso Máquina", "Crucifixo Inverso Polia", "Crucifixo Inverso Halter", "Remada Alta Polia",
                "Remada Alta Pegada Aberta", "Remada Alta Pegada Fechada", "Rotação Externa de Ombro", "Rotação Interna de Ombro"
            ],
            "Bíceps": [
                "Rosca", "Rosca Direta", "Rosca Scott", "Rosca Concentrada", "Rosca Alternada", "Rosca 21",
                "Rosca Martelo", "Rosca Inversa", "Rosca Direta Barra W", "Rosca Direta Barra Reta", "Rosca Direta Polia",
                "Rosca Scott Máquina", "Rosca Scott Livre", "Rosca Alternada com Rotação", "Rosca Martelo Alternada",
                "Rosca Martelo Corda", "Rosca Concentrada Unilateral", "Rosca Spider", "Rosca Inclinada (Banco 45)",
                "Rosca Zottman", "Rosca de Punho", "Rosca Inversa Barra W", "Rosca Polia Alta (Hércules)"
            ],
            "Tríceps": [
                "Tríceps", "Tríceps Corda", "Tríceps Francês", "Tríceps Banco", "Supino Fechado", "Tríceps Pulley",
                "Paralelas", "Tríceps Testa", "Tríceps Coice", "Tríceps Testa Barra W", "Tríceps Testa Halteres",
                "Tríceps Francês Unilateral", "Tríceps Francês Polia", "Tríceps Pulley Barra Reta", "Tríceps Pulley Barra V",
                "Tríceps Pulley Inverso", "Tríceps Coice Polia", "Mergulho no Banco", "Mergulho em Paralelas Assistido",
                "Tríceps Unilateral Polia", "Kickback com Halter", "Tríceps Tate Press", "Tríceps JM Press"
            ],
            "Quadríceps": [
                "Agachamento", "Agachamento Frontal", "Agachamento Hack", "Agachamento Sumô", "Sissy Squat",
                "Goblet Squat", "Leg Press", "Afundo / Passada", "Agachamento Búlgaro", "Cadeira Extensora",
                "Agachamento Livre", "Agachamento Smith", "Agachamento Zercher", "Agachamento com Salto",
                "Leg Press 45", "Leg Press Horizontal", "Leg Press Vertical", "Afundo com Halteres", "Afundo no Smith",
                "Passada Caminhando", "Passada no Lugar", "Passada Traseira (Recuo)", "Step Up", "Subida no Banco",
                "Extensão de Pernas Unilateral", "Pistol Squat (Agachamento Unilateral)"
            ],
            "Posterior de Coxa": [
                "Stiff", "Stiff com Halteres", "Mesa Flexora", "Cadeira Flexora", "Flexora Vertical", "Good Morning",
                "Stiff Unilateral", "Stiff com Barra", "Stiff no Smith", "Flexão de Pernas em Pé", "Flexão Nórdica (Nordic Curl)",
                "Flexão de Joelhos com Bola Suíça", "Elevação de Quadril Unilateral", "Bom Dia (Good Morning)", "Peso Morto Romeno"
            ],
            "Glúteos": [
                "Elevação Pélvica", "Cadeira Abdutora", "Glúteo Coice", "Glúteo 4 Apoios", "Passada Lateral",
                "Abdução de Quadril (Polia)", "Elevação Pélvica Máquina", "Elevação Pélvica Barra", "Elevação Pélvica Unilateral",
                "Glute Bridge", "Glúteo Coice Polia", "Glúteo Coice Máquina", "Abdução de Quadril Máquina", "Abdução de Quadril Caneleira",
                "Passada Lateral com Elástico", "Ostra (Clam Shell)", "Extensão de Quadril no Banco", "Frog Pump"
            ],
            "Pernas (Geral)": [
                "Cadeira Adutora", "Agachamento Isométrico", "Adução de Quadril Máquina", "Adução de Quadril Polia",
                "Agachamento na Parede (Wall Sit)", "Monster Walk", "Pular Corda (Aquecimento Pernas)"
            ],
            "Panturrilhas": [
                "Panturrilha Sentado", "Panturrilha em Pé", "Panturrilha no Leg Press", "Panturrilha Smith", "Panturrilha Sóleo",
                "Panturrilha Unilateral", "Panturrilha Máquina em Pé", "Panturrilha Burrinho", "Panturrilha Tibial Anterior",
                "Gêmeos Sentado", "Gêmeos em Pé", "Panturrilha Isométrica"
            ],
            "Abdômen / Core": [
                "Abdominal", "Prancha Abdominal", "Abdominal Infra", "Abdominal Bike", "Abdominal Remador",
                "Russian Twist", "Vácuo Abdominal", "Abdominal Supra", "Prancha Lateral", "Prancha Dinâmica",
                "Abdominal Tradicional", "Abdominal Grupado", "Abdominal Canivete", "Abdominal Estrela",
                "Elevação de Pernas", "Elevação de Pernas Suspenso", "Elevação de Joelhos", "Ab Wheel (Rodinha)",
                "Crunch na Polia", "Rotação de Tronco Polia (Woodchopper)", "Pallof Press", "Meio Canivete",
                "Abdominal Oblíquo", "Toque no Calcanhar", "Escalador (Mountain Climber)", "Prancha com Elevação de Perna"
            ],
            "Cardio / Funcional": [
                "Corrida", "Bicicleta Ergométrica", "Elíptico", "Pular Corda", "Polichinelo", "Burpees",
                "Caminhada", "Caminhada Inclinada", "Remo Ergométrico", "Escada (Stairmill)", "Box Jump (Salto na Caixa)",
                "Kettlebell Swing", "Kettlebell Clean", "Kettlebell Snatch", "Battle Rope (Corda Naval)", "Wall Ball",
                "Thruster", "Farmer Walk (Caminhada do Fazendeiro)", "Tiro de 100m", "Tiro de 50m", "Polichinelo Frontal",
                "Corrida Estacionária", "Bear Crawl (Engatinhar do Urso)", "Clean & Jerk", "Snatch", "Push Press"
            ]
        };

        // =============================================================================================
        //  DATA ENRICHMENT SYSTEM (RUNTIME)
        //  Populates Micronutrients for 3091 items without manual database rewriting.
        // =============================================================================================
        const NUTRI_PROF = {
            'fruit_citrus': { va: 50, vc: 53, ca: 40, fe: 0.1, pot: 180, chol: 0, sug: 9, sf: 0, tf: 0 },
            'fruit_banana': { va: 64, vc: 9, ca: 5, fe: 0.3, pot: 358, chol: 0, sug: 12, sf: 0.1, tf: 0 },
            'fruit_gen': { va: 50, vc: 15, ca: 10, fe: 0.2, pot: 150, chol: 0, sug: 10, sf: 0, tf: 0 },
            'veg_leafy': { va: 400, vc: 40, ca: 100, fe: 2.5, pot: 300, chol: 0, sug: 0.2, sf: 0, tf: 0 },
            'veg_root': { va: 800, vc: 5, ca: 30, fe: 0.8, pot: 320, chol: 0, sug: 5, sf: 0, tf: 0 },
            'red_meat': { va: 0, vc: 0, ca: 12, fe: 2.5, pot: 300, chol: 85, sug: 0, sf: 5, tf: 0.3 },
            'white_meat': { va: 0, vc: 0, ca: 15, fe: 1.0, pot: 250, chol: 80, sug: 0, sf: 1, tf: 0 },
            'fish': { va: 40, vc: 0, ca: 20, fe: 0.5, pot: 400, chol: 60, sug: 0, sf: 1, tf: 0 },
            'egg': { va: 160, vc: 0, ca: 50, fe: 1.5, pot: 130, chol: 370, sug: 0.5, sf: 3, tf: 0 },
            'dairy_milk': { va: 50, vc: 0, ca: 120, fe: 0.05, pot: 150, chol: 10, sug: 5, sf: 1.5, tf: 0 },
            'dairy_cheese': { va: 200, vc: 0, ca: 700, fe: 0.5, pot: 90, chol: 90, sug: 0.5, sf: 18, tf: 0.5 },
            'grain': { va: 0, vc: 0, ca: 10, fe: 2, pot: 100, chol: 0, sug: 0.5, sf: 0.2, tf: 0 },
            'sugar': { va: 0, vc: 0, ca: 0, fe: 0, pot: 0, chol: 0, sug: 99, sf: 0, tf: 0 },
            'proc_salty': { va: 0, vc: 0, ca: 50, fe: 1, pot: 200, chol: 40, sug: 1, sf: 8, tf: 0.1 },
            'default': { va: 0, vc: 0, ca: 10, fe: 0.5, pot: 100, chol: 0, sug: 2, sf: 0.5, tf: 0 }
        };



        function enrichDB() {
            DB_F.forEach(f => {
                if (f.enriched) return; // Already processed

                let p = NUTRI_PROF.default;
                const n = f.n.toLowerCase();

                // Advanced Keyword Mapping
                if (n.includes('laranja') || n.includes('limão') || n.includes('acerola') || n.includes('morango') || n.includes('tangerina') || n.includes('maracujá')) p = NUTRI_PROF.fruit_citrus;
                else if (n.includes('banana')) p = NUTRI_PROF.fruit_banana;
                else if (n.includes('maçã') || n.includes('uva') || n.includes('manga') || n.includes('pera') || n.includes('abacaxi') || n.includes('fruta')) p = NUTRI_PROF.fruit_gen;
                else if (n.includes('alface') || n.includes('couve') || n.includes('rúcula') || n.includes('espinafre') || n.includes('agrião') || n.includes('brócolis')) p = NUTRI_PROF.veg_leafy;
                else if (n.includes('cenoura') || n.includes('batata') || n.includes('beterraba') || n.includes('abóbora')) p = NUTRI_PROF.veg_root;
                else if (n.includes('carne') || n.includes('bife') || n.includes('picanha') || n.includes('patinho') || n.includes('hambúrguer') || n.includes('boi')) p = NUTRI_PROF.red_meat;
                else if (n.includes('frango') || n.includes('peito') || n.includes('peru') || n.includes('ave')) p = NUTRI_PROF.white_meat;
                else if (n.includes('peixe') || n.includes('tilápia') || n.includes('salmão') || n.includes('atum') || n.includes('camarão')) p = NUTRI_PROF.fish;
                else if (n.includes('ovo') || n.includes('omelete')) p = NUTRI_PROF.egg;
                else if (n.includes('leite') || n.includes('iogurte') || n.includes('whey')) p = NUTRI_PROF.dairy_milk;
                else if (n.includes('queijo') || n.includes('requeijão') || n.includes('mussarela')) p = NUTRI_PROF.dairy_cheese;
                else if (n.includes('arroz') || n.includes('feijão') || n.includes('pão') || n.includes('aveia') || n.includes('macarrão') || n.includes('trigo')) p = NUTRI_PROF.grain;
                else if (n.includes('açúcar') || n.includes('doce') || n.includes('chocolate') || n.includes('bolo') || n.includes('biscoito') || n.includes('bala') || n.includes('refrigerante')) p = NUTRI_PROF.sugar;
                else if (n.includes('salgado') || n.includes('presunto') || n.includes('calabresa') || n.includes('salsicha') || n.includes('bacon')) p = NUTRI_PROF.proc_salty;

                // Apply Profile Values (Only if missing)
                // Note: Macronutrients (k,p,c,f,fib,sod) are preserved from Original DB.
                // We add: vac, vc, ca, fe, pot, chol, sug, sf, tf

                f.va = f.va !== undefined ? f.va : p.va;
                f.vc = f.vc !== undefined ? f.vc : p.vc;
                f.ca = f.ca !== undefined ? f.ca : p.ca;
                f.fe = f.fe !== undefined ? f.fe : p.fe;
                f.pot = f.pot !== undefined ? f.pot : p.pot;
                f.chol = f.chol !== undefined ? f.chol : p.chol;

                // Sugar/Fat Logic:
                // If f.c (Carb) is low, Sug can't be high. Cap at f.c.
                f.sug = f.sug !== undefined ? f.sug : Math.min(f.c, p.sug);

                // If f.f (Fat) is low, Sat/Trans can't be high.
                f.sf = f.sf !== undefined ? f.sf : Math.min(f.f, p.sf);
                f.tf = f.tf !== undefined ? f.tf : Math.min(f.f * 0.1, p.tf); // Assumption: Trans is low

                f.enriched = true;
            });
        }

        function openNutriDetail() {
            st.v = 'nutri-detail';
            render();

            if (!app.h[st.d]) return;
            const day = app.h[st.d];

            // 1. Calculate Daily Totals
            let T = {
                k: 0, p: 0, c: 0, f: 0, fib: 0, sod: 0,
                sug: 0, sf: 0, tf: 0, chol: 0, pot: 0, va: 0, vc: 0, ca: 0, fe: 0
            };

            ['b', 'l', 'd'].forEach(k => { // Breakfast, Lunch, Dinner
                day[k].forEach(x => {
                    const f = DB_F.find(y => y.id == x.id);
                    if (!f) return; // Safety Check
                    const r = x.g / 100; // Ratio (Standard 100g/ml)

                    T.k += f.k * r; T.p += f.p * r; T.c += f.c * r; T.f += f.f * r;
                    T.fib += (f.fib || 0) * r; T.sod += (f.sod || 0) * r;

                    // Micros (Enriched)
                    T.sug += (f.sug || 0) * r; T.sf += (f.sf || 0) * r; T.tf += (f.tf || 0) * r;
                    T.chol += (f.chol || 0) * r; T.pot += (f.pot || 0) * r;
                    T.va += (f.va || 0) * r; T.vc += (f.vc || 0) * r; T.ca += (f.ca || 0) * r; T.fe += (f.fe || 0) * r;
                });
            });

            // 2. Define Goals (Dynamic or Default RDA)
            // Use Profile Goals if available, else standard RDA
            const g = app.p.goals || {};
            const RDA = {
                k: g.k || 2000, p: g.p || 150, c: g.c || 250, f: g.f || 70,
                fib: g.fib || 30, sod: g.sod || 2300,
                sug: 50, sf: 20, tf: 2, // WHO Limits
                chol: 300, pot: 4700, va: 900, vc: 90, ca: 1000, fe: 14 // Standard RDA
            };

            // 3. Render List
            // COMPENSATION LOGIC (Carb <-> Fat)
            // Rule: If Total Calories <= 110%, allow Carb Excess if Fat Deficit covers it (and vice-versa).
            const calOk = (T.k <= (RDA.k * 1.10));

            const excC = T.c - RDA.c; // Excess Carb
            const defF = RDA.f - T.f; // Deficit Fat
            const excF = T.f - RDA.f; // Excess Fat
            const defC = RDA.c - T.c; // Deficit Carb

            // Flags to IGNORE Red State
            // If Cal OK AND (Excess C covered by Deficit F)
            const ignoreC = calOk && (excC > 0 && defF >= excC);
            // If Cal OK AND (Excess F covered by Deficit C)
            const ignoreF = calOk && (excF > 0 && defC >= excF);

            const mkRow = (lbl, val, max, unit, colorCls = 'cal') => {
                const pct = Math.min((val / max) * 100, 100);

                // 10% TOLERANCE LOGIC + COMPENSATION
                let finalColorClass = colorCls;
                let styleOverride = "";

                // Check if this specific row is compensated
                let isCompensated = false;
                if (lbl.includes('Carboidratos') && ignoreC) isCompensated = true;
                if (lbl.includes('Gorduras Totais') && ignoreF) isCompensated = true;

                if (max > 0 && val > (max * 1.10) && !isCompensated) {
                    // Exceeded by more than 10% AND NOT Compensated -> Force Red
                    finalColorClass = '';
                    styleOverride = 'background-color: #ff453a; box-shadow: 0 0 10px rgba(255, 69, 58, 0.4);';
                }

                return `
                 <div class="nutri-bar-row">
                    <div class="nutri-meta">
                        <span>${lbl}</span>
                        <span class="nutri-val">${Math.round(val)} / ${max}${unit}</span>
                    </div>
                    <div class="p-track"><div class="p-fill ${finalColorClass}" style="width:${pct}%; ${styleOverride}"></div></div>
                 </div>`;
            };

            const container = document.getElementById('nutri-detail-list');
            if (container) container.innerHTML = `
                <h3 style="margin:10px 0 10px; border-bottom:1px solid var(--border); padding-bottom:5px;">Macronutrientes</h3>
                ${mkRow('Calorias', T.k, RDA.k, ' kcal', 'cal')}
                ${mkRow('Proteínas', T.p, RDA.p, 'g', 'prot')}
                ${mkRow('Carboidratos', T.c, RDA.c, 'g', 'carb')}
                ${mkRow('Gorduras Totais', T.f, RDA.f, 'g', 'fat')}

                <h3 style="margin:20px 0 10px; border-bottom:1px solid var(--border); padding-bottom:5px;">Detalhamento Gorduras & Açúcar</h3>
                ${mkRow('Gorduras Saturadas', T.sf, RDA.sf, 'g', 'fat')}
                ${mkRow('Gorduras Trans', T.tf, RDA.tf, 'g', 'exc')}
                ${mkRow('Açúcares', T.sug, RDA.sug, 'g', 'carb')}

                <h3 style="margin:20px 0 10px; border-bottom:1px solid var(--border); padding-bottom:5px;">Micronutrientes Essenciais</h3>
                ${mkRow('Fibras', T.fib, RDA.fib, 'g', 'prot')}
                ${mkRow('Sódio', T.sod, RDA.sod, 'mg', 'exc')}
                ${mkRow('Colesterol', T.chol, RDA.chol, 'mg', 'exc')}
                ${mkRow('Potássio', T.pot, RDA.pot, 'mg', 'prot')}
                ${mkRow('Vitamina A', T.va, RDA.va, 'µg', 'prot')}
                ${mkRow('Vitamina C', T.vc, RDA.vc, 'mg', 'prot')}
                ${mkRow('Cálcio', T.ca, RDA.ca, 'mg', 'prot')}
                ${mkRow('Ferro', T.fe, RDA.fe, 'mg', 'prot')}
            `;
        }

        function closeNutriDetail() {
            st.v = 'diary';
            render();
        }

        console.log("NutriApp: Carregando definições globais...");
        let app = {
            h: {},
            w: { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] },
            p: {},
            r: [],
            fav: [], // Favorites Food
            favE: [], // Favorites Ex
            rec: [], // Recents Food
            recE: [], // Recents Ex
            settings: { themeMode: 'dark' }
        };
        let st = { d: new Date().toISOString().split('T')[0], v: 'diary', ctx: '', day: 'mon', ri: [], rimp: null };

        function save() { try { localStorage.setItem('nutriV7', JSON.stringify(app)); } catch (e) { console.error("Save Error:", e); } }
        function closeM() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        function go(v) { st.v = v; render(); window.scrollTo(0, 0); }



        function enrichDB() {
            // Placeholder: Ensure micronutrients exist if needed
            if (window.DB_F) window.DB_F.forEach(f => { if (!f.fib) f.fib = 0; });
        }

        function init() {
            // SAFE ALPHABETICAL SORT (A-Z)
            // Ensures all items are ordered visually without altering the data file structure.
            DB_F.sort((a, b) => a.n.localeCompare(b.n));

            // CRITICAL FIX: DEDUPLICATE IDs
            // Some items in the database share the same ID. This fixes the collision to ensure Favorites work correctly.
            // This happens at runtime so the static database remains "untouched".
            const seenIds = new Set();
            let maxId = 0;
            // First pass: Find real max ID
            DB_F.forEach(f => { if (f.id > maxId) maxId = f.id; });

            // Second pass: Reassign duplicates
            DB_F.forEach(f => {
                if (seenIds.has(f.id)) {
                    maxId++;
                    f.id = maxId;
                }
                seenIds.add(f.id);
            });

            const s = localStorage.getItem('nutriV7');
            let saved = {};
            if (s) try { saved = JSON.parse(s) } catch (e) { }

            // =========================================================================================
            //  FINAL PERSISTENCE SAFETY LOCK (DO NOT MODIFY)
            //  Prevents data reset by forcing a DEEP MERGE of Saved Data over Code Defaults.
            // =========================================================================================

            // 1. Capture Code-Defined Defaults (Structure Anchor)
            const defaults = { ...app };

            // 2. Base Merge: Apply saved data on top of defaults
            // This restores user data but might overwrite new nested default keys
            app = { ...defaults, ...saved };

            // 3. Deep Merge Critical Sections (Profile 'p')
            // Ensures new code-defined defaults in 'p' (e.g. goals, settings) persist
            // even if the saved 'p' object doesn't have them.
            app.p = { ...(defaults.p || {}), ...(saved.p || {}) };

            // 4. Deep Merge Workouts 'w' to ensure all days exist
            if (defaults.w) {
                app.w = { ...defaults.w, ...(saved.w || {}) };
            }

            // 5. Restore Fallbacks if something went wrong
            if (!app.h) app.h = {};

            if (!app.r) app.r = [];
            if (!app.fav) app.fav = [];
            if (!app.rec) app.rec = []; // Recents Food
            if (!app.favE) app.favE = []; // Favorites Exercises
            if (!app.recE) app.recE = []; // Recents Exercises

            // 6. Ensure Base Profile Defaults if empty
            if (Object.keys(app.p).length === 0) {
                app.p = { act: "1.2", sex: "m", goal: 0, w: "", h: "", age: "" };
            } else {
                // Ensure specific critical keys exist if partial profile
                if (!app.p.act) app.p.act = "1.2";
                if (!app.p.goal) app.p.goal = 0;
            }

            if (typeof renderFList === 'function') {
                const fl = document.getElementById('f-list');
                if (fl) renderFList();
            }

            const risel = document.getElementById('r-isel');
            if (risel) risel.innerHTML = '<option value="">...</option>' + DB_F.map(f => `<option value="${f.id}">${f.n}</option>`).join('');


            if (app.p.av) {
                const pav = document.getElementById('p-av');
                if (pav) pav.style.backgroundImage = `url(${app.p.av})`;
            }

            enrichDB(); // Populate Micronutrients based on keywords
            if (app.p.name) {
                const pn = document.getElementById('p-name');
                if (pn) pn.value = app.p.name;
            }
            document.getElementById('p-w').value = app.p.w || '';
            document.getElementById('p-h').value = app.p.h || '';
            document.getElementById('p-age').value = app.p.age || '';
            if (document.getElementById('p-sex')) document.getElementById('p-sex').value = app.p.sex || 'm';

            // Theme Init
            if (app.settings && app.settings.themeMode === 'light') {
                document.body.classList.add('light-mode');
                const pill = document.getElementById('theme-pill');
                if (pill) pill.style.transform = 'translateX(54px)';
            }
            document.getElementById('p-act').value = app.p.act || '1.2';
            document.getElementById('p-goal').value = app.p.goal || 0;

            if (app.p.m) {
                const M = ['shoulder', 'chest', 'neck', 'waist', 'hip', 'arm-l', 'arm-r', 'forearm-l', 'forearm-r', 'thigh-l', 'thigh-r', 'calf-l', 'calf-r'];
                M.forEach(k => {
                    const el = document.getElementById('m-' + k);
                    if (el) {
                        // Priority: Exact key 'arm-l' > Legacy key 'arml'
                        el.value = app.p.m[k] || app.p.m[k.replace('-', '')] || '';
                    }
                });
            }

            // Ensure Default View is Front on Init
            setBodyView('front');

            calcTMB();

            setDate(st.d);

            console.log("NutriApp: Inicialização concluída, renderizando...");
            render();
            if (typeof drawStaticGuides === 'function') drawStaticGuides();
        }

        function openDatePicker() { document.getElementById('date-input-hidden').showPicker(); }
        function onDateChange(v) { setDate(v); }
        function setDate(v) {
            st.d = v;
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            const yesterdayD = new Date(); yesterdayD.setDate(now.getDate() - 1);
            const yesterday = yesterdayD.toISOString().split('T')[0];

            const tomorrowD = new Date(); tomorrowD.setDate(now.getDate() + 1);
            const tomorrow = tomorrowD.toISOString().split('T')[0];

            let label = "";
            const el = document.getElementById('date-text');

            if (v === today) {
                label = "Hoje";
                el.classList.add('is-today');
            } else {
                el.classList.remove('is-today');
                if (v === yesterday) label = "Ontem";
                else if (v === tomorrow) label = "Amanhã";
                else {
                    const d = new Date(v + 'T00:00:00');
                    label = d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                }
            }

            el.innerText = label;
            render();
        }

        function changeDate(o) {
            const d = new Date(st.d + 'T00:00:00');
            d.setDate(d.getDate() + o);
            setDate(d.toISOString().split('T')[0]);
        }

        function render() {
            const v = st.v;

            // 1. Toggle High-Level View Containers (Ensures total isolation)
            document.getElementById('view-diary').style.display = (v === 'diary') ? 'block' : 'none';
            document.getElementById('view-recipes').style.display = (v === 'recipes') ? 'block' : 'none';
            document.getElementById('view-workout').style.display = (v === 'workout') ? 'block' : 'none';
            document.getElementById('view-profile').style.display = (v === 'profile') ? 'block' : 'none';

            // 2. Full Screen Page Visibility
            const ndPage = document.getElementById('nutri-detail-page');
            if (ndPage) ndPage.style.display = (v === 'nutri-detail') ? 'block' : 'none';

            // HIDE NAV & SETTINGS IN FULL SCREEN MODE
            const nav = document.querySelector('nav');
            if (nav) nav.style.display = (v === 'nutri-detail') ? 'none' : 'flex';

            const sets = document.getElementById('btn-settings');
            if (sets) sets.style.display = (v === 'profile') ? 'flex' : 'none'; // Only show settings in Profile (or Diary? User didn't specify, Assuming Diary/Profile)
            // Actually, keep default behavior for settings button (it was inside Main, so hidden if Main hidden? No, Settings inside Main.)
            // If we hide Main contents via ID toggles, Settings remains visible if not toggled.
            // Let's rely on standard toggles above.

            // Special handling for Profile View (if implemented separately or shared)
            // Currently Profile is just 'p-settings' blocks inside Main? 
            // The HTML structure puts Profile inputs inside Main. They are not wrapped in a single ID?
            // "p-container"? No.
            // Let's assume Profile elements are always visible unless hidden? 
            // Wait, existing render logic relies on 'v'. 
            // Let's look at existing code: 
            // document.getElementById('daily-summary-card').style.display = st.v === 'diary' ? 'block' : 'none';
            // It seems 'diary' shows summary card.
            // What hides Profile inputs? 
            // Profile inputs seem to be always there? No, usually wrapped.
            // Let's Stick to implementing 'nutri-detail' visibility explicitly.

            if (st.v === 'diary') {
                if (!app.h[st.d]) app.h[st.d] = { b: [], l: [], d: [], w: 0 };
                const day = app.h[st.d];
                const M = { b: 'Café da manhã', l: 'Almoço', d: 'Jantar' };
                let G = { k: 0, p: 0, c: 0, f: 0, fib: 0, sod: 0 };

                // Helper for Toggle
                window.toggleM = function (k) {
                    if (!st.m_exp) st.m_exp = {};
                    st.m_exp[k] = !st.m_exp[k];
                    const open = st.m_exp[k];
                    const l = document.getElementById('list-' + k);
                    const a = document.getElementById('arr-' + k);
                    if (l && a) {
                        if (open) {
                            l.classList.remove('closed');
                            a.classList.remove('closed');
                        } else {
                            l.classList.add('closed');
                            a.classList.add('closed');
                        }
                    }
                };

                document.getElementById('meals-container').innerHTML = Object.keys(M).map(k => {
                    // State Init
                    if (!st.m_exp) st.m_exp = {};
                    if (st.m_exp[k] === undefined) st.m_exp[k] = (day[k].length > 0);
                    const isOpen = st.m_exp[k];
                    const cls = isOpen ? '' : 'closed';

                    let K = 0, P = 0, C = 0, F = 0;
                    const L = day[k].map((x, i) => {
                        const f = DB_F.find(y => y.id == x.id);
                        if (!f) return ''; // Safety Check
                        const r = x.g / 100;
                        const m = { k: f.k * r, p: f.p * r, c: f.c * r, f: f.f * r, fib: (f.fib || 0) * r, sod: (f.sod || 0) * r };

                        K += m.k; P += m.p; C += m.c; F += m.f;
                        G.k += m.k; G.p += m.p; G.c += m.c; G.f += m.f; G.fib += m.fib; G.sod += m.sod;

                        return `<div class="item" style="flex-direction:column; align-items:stretch; padding:8px 0;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
                                <div style="line-height:1.2;"><b>${f.n}</b> <small style="color:#888">${x.g}g</small></div>
                                <span onclick="event.stopPropagation(); delF('${k}',${i})" style="color:#f44;cursor:pointer; padding-left:10px;">×</span>
                            </div>
                            <div style="font-size:0.75rem; color:var(--text-med); margin-top:2px; display:flex; gap:8px;">
                                <span style="color:var(--primary); font-weight:700;">${Math.round(m.k)} kcal</span>
                                <span>C ${Math.round(m.c)}g</span>
                                <span>P ${Math.round(m.p)}g</span>
                                <span>G ${Math.round(m.f)}g</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `<div class="card">
                        <div class="card-head" style="align-items:flex-start" onclick="toggleM('${k}')">
                            <div style="flex:1">
                                <span style="font-size:1.3rem; font-weight:800; color:var(--text-high); letter-spacing:-0.5px; display:block; line-height:1.2;">${M[k]}</span>
                                <span style="font-size:0.75rem; color:var(--text-med); font-weight:500; display:block; margin-top:3px;">
                                    C ${Math.round(C)}g <span style="opacity:0.3; margin:0 3px">•</span> P ${Math.round(P)}g <span style="opacity:0.3; margin:0 3px">•</span> G ${Math.round(F)}g
                                </span>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                                <span style="font-weight:700; color:var(--primary); font-size:0.95rem; margin-top:4px;">${Math.round(K)} kcal</span>
                                <svg id="arr-${k}" class="arrow-icon ${cls}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-med);"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                        </div>
                        <div id="list-${k}" class="meal-list ${cls}">
                            ${L}
                            <div class="btn-pill" onclick="event.stopPropagation(); opFM('${k}')">+ Adicionar Alimento</div>
                        </div>
                    </div>`;
                }).join('');

                // PREMIUM SUMMARY DISPLAY
                const gl = app.p.goals;
                if (gl) {

                    // COMPENSATION LOGIC (Identical to Detail Screen)
                    // Rule: If Total Calories <= 110%, allow Carb Excess if Fat Deficit covers it (and vice-versa).
                    const calOk = (G.k <= (gl.k * 1.10));
                    const excC = G.c - gl.c;
                    const defF = gl.f - G.f;
                    const excF = G.f - gl.f;
                    const defC = gl.c - G.c;

                    const ignoreC = calOk && (excC > 0 && defF >= excC);
                    const ignoreF = calOk && (excF > 0 && defC >= excF);

                    const mkBar = (cur, max, colorClass, label, unit) => {
                        const pct = Math.min((cur / max) * 100, 100);
                        const diff = max - cur;

                        // 10% Tolerance Logic
                        let isExc = (max > 0 && cur > (max * 1.10));

                        // Compensation Override
                        if (label.includes('Carboidratos') && ignoreC) isExc = false;
                        if (label.includes('Gorduras') && ignoreF) isExc = false;

                        const diffTxt = (cur > max) ? `Excedeu ${Math.abs(diff)}${unit}` : `Faltam ${diff}${unit}`;
                        const diffColor = isExc ? '#ff453a' : 'var(--text-med)';
                        const barColor = isExc ? 'exc' : colorClass;
                        // Note: If isExc is false but cur > max, we still show "Excedeu" text (neutral color) but NOT Red Bar.

                        return `
                        <div class="n-row">
                            <div class="n-head">
                                <span>${label}</span>
                                <span class="n-det">${cur} / ${max}${unit}</span>
                            </div>
                            <div class="p-track"><div class="p-fill ${barColor}" style="width:${pct}%"></div></div>
                            <div style="text-align:right; font-size:0.7rem; color:${diffColor}; margin-top:3px;">${diffTxt}</div>
                        </div>`;
                    };

                    // Calories Special Display
                    const cCur = Math.round(G.k); const cMax = gl.k;
                    const cDiff = cMax - cCur;

                    // 10% Tolerance Logic for Calories
                    const cExc = (cMax > 0 && cCur > (cMax * 1.10));

                    const cPct = Math.min((cCur / cMax) * 100, 100);
                    // Text distinction: Excedeu vs Faltam, but Red only if > 110%
                    const cTxt = (cCur > cMax) ? `Excedeu ${Math.abs(cDiff)} kcal` : `Faltam ${cDiff} kcal`;
                    const cColor = cExc ? '#ff453a' : 'var(--primary)';

                    document.getElementById('daily-summary-card').innerHTML = `
                        <div class="sum-box" onclick="openNutriDetail()" style="cursor:pointer;">
                            <div class="sum-cal-row">
                                <div>
                                    <span class="sum-cal-val">${cCur}</span>
                                    <span class="sum-cal-lbl">/ ${cMax} kcal</span>
                                </div>
                                <span class="sum-diff" style="color:${cExc ? '#ff453a' : 'var(--primary)'}">${cTxt}</span>
                                <div class="p-track lg"><div class="p-fill ${cExc ? 'exc' : 'cal'}" style="width:${cPct}%"></div></div>
                            </div>
                            
                            <div class="macro-list">
                                ${mkBar(Math.round(G.p), gl.p, 'prot', 'Proteínas', 'g')}
                                ${mkBar(Math.round(G.c), gl.c, 'carb', 'Carboidratos', 'g')}
                                ${mkBar(Math.round(G.f), gl.f, 'fat', 'Gorduras', 'g')}
                            </div>

                            <div class="micro-grid">
                                <div class="micro-item">
                                    <span class="micro-lbl">Fibras</span>
                                    <span class="micro-val">${Math.round(G.fib)} / ${gl.fib}g</span>
                                    <div class="p-track" style="height:4px;"><div class="p-fill" style="width:${Math.min((G.fib / gl.fib) * 100, 100)}%; background:var(--text-high);"></div></div>
                                </div>
                                <div class="micro-item">
                                    <span class="micro-lbl">Sódio</span>
                                    <span class="micro-val">${Math.round(G.sod)} / ${gl.sod}mg</span>
                                    <div class="p-track" style="height:4px;"><div class="p-fill" style="width:${Math.min((G.sod / gl.sod) * 100, 100)}%; background:var(--text-high);"></div></div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    document.getElementById('daily-summary-card').innerHTML = `<div style="text-align:center; padding:15px; color:var(--text-med); font-size:0.9rem;">
                        <b>Metas não definidas!</b><br>Vá em Perfil, preencha seus dados e salve para ver suas metas aqui.
                    </div>`;
                }

                const w = day.w || 0;
                const wGoal = (app.p.goals && app.p.goals.water) ? app.p.goals.water : 2000;
                document.getElementById('w-val').innerText = `${w} / ${wGoal} ml`;
                document.getElementById('w-bar').style.width = Math.min((w / wGoal) * 100, 100) + '%';
            }

            if (st.v === 'recipes') {
                document.getElementById('rec-list').innerHTML = app.r.map((r, i) => `
                <div class="card rec-item">
                    <div class="rec-thumb" style="background-image:url(${r.img})"></div>
                    <div style="flex:1"><b>${r.n}</b><br><small>${r.cal} kcal</small></div>
                    <span onclick="delR(${i})" style="color:#f44;cursor:pointer">×</span>
                </div>
            `).join('');
            }

            if (st.v === 'workout') {
                const days = { mon: 'Seg', tue: 'Ter', wed: 'Qua', thu: 'Qui', fri: 'Sex', sat: 'Sáb', sun: 'Dom' };
                document.getElementById('day-scroller').innerHTML = Object.keys(days).map(d =>
                    `<div class="day-chip ${st.day === d ? 'active' : ''}" onclick="st.day='${d}';render()">${days[d]}</div>`
                ).join('');
                const l = app.w[st.day] || [];
                document.getElementById('work-list').innerHTML = l.length ? l.map((e, i) =>
                    `<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #333;"><div><b>${e.n}</b> <small>${e.s}x${e.r}</small></div><span onclick="delE(${i})" style="color:#f44;cursor:pointer">×</span></div>`
                ).join('') : 'Descanso';
            }

            save();
        }

        function upAv(i) { const f = i.files[0]; if (f) { const r = new FileReader(); r.onload = e => { app.p.av = e.target.result; render(); location.reload(); }; r.readAsDataURL(f); } }

        // SINGLE SOURCE OF TRUTH: calcTMB updates Global State (app.p)
        function calcTMB() {
            let w = parseFloat(document.getElementById('p-w').value);
            // Weight Validation (20kg - 500kg)
            if (w < 20) { w = 20; document.getElementById('p-w').value = 20; }
            if (w > 500) { w = 500; document.getElementById('p-w').value = 500; }

            let h = parseFloat(document.getElementById('p-h').value);
            // Height Validation (50cm - 260cm)
            if (h < 50) { h = 50; document.getElementById('p-h').value = 50; }
            if (h > 260) { h = 260; document.getElementById('p-h').value = 260; }

            let a = parseFloat(document.getElementById('p-age').value);
            // Age Validation (13y - 120y)
            if (a < 13) { a = 13; document.getElementById('p-age').value = 13; }
            if (a > 120) { a = 120; document.getElementById('p-age').value = 120; }

            const s = document.getElementById('p-sex').value, act = parseFloat(document.getElementById('p-act').value), g = parseFloat(document.getElementById('p-goal').value);

            // 1. CLEAR PREVIOUS MESSAGES
            const msgEl = document.getElementById('tmb-msg');
            msgEl.style.display = 'none';
            msgEl.className = '';
            msgEl.innerText = '';

            // 2. CHECK IF INPUTS ARE VALID
            if (w && h && a) {
                // --- STEP 1: BMI Calculation ---
                // Height in meters for BMI
                const h_m = h / 100;
                const bmi = w / (h_m * h_m);

                // --- STEP 2: Weight Definition ---
                let calcWeight = w;
                let isAdjusted = false;

                // Rule: If BMI > 30, use Adjusted Weight
                if (bmi > 30) {
                    const weightIdeal = 24.9 * (h_m * h_m);
                    const weightAdj = weightIdeal + 0.25 * (w - weightIdeal);
                    calcWeight = weightAdj;
                    isAdjusted = true;
                }

                // --- STEP 3: TMB (Mifflin-St Jeor) ---
                // PURE BASAL: (10 * W) + (6.25 * H_cm) - (5 * A) + 5 or -161
                // STRICTLY NO ACTIVITY FACTOR HERE
                let tmb = (10 * calcWeight) + (6.25 * h) - (5 * a) + ((s === 'm') ? 5 : -161);

                // --- NEW LOCK: MINIMUM SAFETY LIMIT (BMR) ---
                let hitMin = false;
                const minSaf = (s === 'm') ? 1200 : 1000;

                if (tmb < minSaf) {
                    tmb = minSaf;
                    hitMin = true;
                }

                // --- STEP 4: Activity Factor (TDEE) ---
                // DEFAULT TO 1.2 IF UNDEFINED/ZERO
                let usedAct = act;
                if (!usedAct || usedAct < 1.2) usedAct = 1.2;

                let tdee = tmb * usedAct;

                let targetCal = Math.round(tmb * (1 + g));

                // Locks
                let hitMax = false;

                // USER REQUIREMENT: HARD LIMIT 5000 KCAL
                if (targetCal > 5000) {
                    targetCal = 5000;
                    hitMax = true;
                }

                // SAFETY FLOOR FOR GOAL
                if (targetCal < minSaf) {
                    targetCal = minSaf;
                    // hitMin = true; // Optional: Treat this as safety warning too? User said "BMR or TDEE". 
                    // But if Goal is below BMR, it violates "vital functions" logic usually.
                    // I will mark hitMin true to ensure the warning appears if the final goal is dangerously low.
                    hitMin = true;
                }

                // --- MESSAGES ---
                // Priority: Min Limit > Max Limit > Optimization Message
                let msgText = "";

                if (hitMin) {
                    msgText = "Limite mínimo de segurança atingido para garantir funções vitais.";
                    msgEl.style.color = "#ff4444";
                    msgEl.style.background = "rgba(255, 68, 68, 0.1)";
                    msgEl.style.display = "block";
                } else if (hitMax) {
                    msgText = "Limite máximo de segurança (5000 kcal) atingido";
                    msgEl.style.color = "#ff4444"; // Red warning
                    msgEl.style.background = "rgba(255, 68, 68, 0.1)";
                    msgEl.style.display = "block";
                }

                // Always show Optimization message if BMI > 40, potentially appending?
                // User said: "Sempre que o IMC for maior que 40, exiba..."
                if (bmi > 40) {
                    const optMsg = "Cálculo otimizado para sua composição corporal atual.";
                    if (msgText) {
                        msgText += " | " + optMsg;
                    } else {
                        msgText = optMsg;
                        msgEl.style.color = "#44ff44"; // Green/Success or Neutral
                        if (!document.body.classList.contains('light-mode')) msgEl.style.color = "#88ff88"; // distinct enough
                        msgEl.style.background = "rgba(68, 255, 68, 0.1)";
                        msgEl.style.display = "block";
                    }
                }

                if (msgText) {
                    msgEl.innerText = msgText;
                    if (hitMax) {
                        // Ensure red style takes precedence or is clear
                        msgEl.style.border = "1px solid " + msgEl.style.color;
                    }
                }


                // Macros Calculation (approx standard distribution based on new target)
                let p_g = Math.round(calcWeight * 2.0); // Use Adjusted Weight for Protein to prevent excesses in high BMI
                // Standard practice for obese individuals is often based on LBM or adjusted weight for protein too, 
                // but user didn't specify. Left as 'w' (actual) per previous code, unless it yields impossible macros.
                // However, with 4500 cal limit, 2g/kg for 150kg = 300g prot = 1200kcal. Feasible.

                let f_g = Math.round((targetCal * 0.25) / 9);
                let c_g = Math.round((targetCal - (p_g * 4 + f_g * 9)) / 4);

                // Sanity check for negative Carbs if Protein is too high on low cal?
                // Just in case:
                if (c_g < 0) c_g = 0;

                goals = {
                    k: targetCal,
                    p: p_g,
                    c: c_g,
                    f: f_g,
                    fib: 30,
                    sod: 2300,
                    water: Math.ceil((w * ({ "1.2": 35, "1.375": 38, "1.55": 42, "1.725": 50 }[String(act)] || 35)) / 10) * 10
                };

                // Display Breakdown
                // 1. Basal (Pure)
                document.getElementById('tmb-base').innerText = Math.round(tmb);



                // 3. Goal (Meta) with Dynamic Label
                const goalEl = document.getElementById('tmb-res');
                const goalLbl = document.getElementById('tmb-goal-lbl');

                if (goalEl) goalEl.innerText = targetCal + ' kcal';

                if (goalLbl) {
                    let gTxt = "Manter Peso";
                    if (g < 0) gTxt = "Perder Peso (-15%)";
                    if (g > 0) gTxt = "Ganhar Peso (+15%)";

                    // Show relationship: Goal = TDEE +/- %
                    goalLbl.innerText = `Sua Meta (${gTxt})`;
                }
            }

            // 2. SAVE to Global State
            app.p = {
                w, h, age: a, sex: s, act, goal: g,
                name: document.getElementById('p-name').value,
                av: app.p.av,
                goals: goals // PERSISTED GOALS
            };
            if (!app.p.goals) app.p.goals = null; // Ensure consistency

            save(); // Persist to LocalStorage

            if (st.v === 'diary') render(); // 3. REACTIVITY: Update Diary immediately if active

            // FORCE AVATAR UPDATE ON GENDER CHANGE
            if (typeof setBodyView === 'function') {
                // Determine current view state or default to front
                const view = (typeof currentBodyView !== 'undefined') ? currentBodyView : 'front';
                setBodyView(view);
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isLight = body.classList.toggle('light-mode');
            const mode = isLight ? 'light' : 'dark';
            app.settings = app.settings || {};
            app.settings.themeMode = mode;

            // Move both pills (profile and settings)
            const pill = document.getElementById('theme-pill');
            const pillSettings = document.getElementById('theme-pill-settings');
            const transform = isLight ? 'translateX(54px)' : 'translateX(0)';

            if (pill) {
                pill.style.transform = transform;
            }
            if (pillSettings) {
                pillSettings.style.transform = transform;
            }

            save();
        }
        function saveProf() { app.p.name = document.getElementById('p-name').value; save(); }
        function toggleMeasures(btn) {
            const container = document.getElementById('measures-container');
            const isOpen = container.classList.toggle('open');
            btn.classList.toggle('active');
        }
        function toggleSettings(btn) {
            const container = document.getElementById('settings-container');
            const isOpen = container.classList.toggle('open');
            btn.classList.toggle('active');
        }
        function focusMeasure(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('highlight-flash');
                el.focus();
                setTimeout(() => el.classList.remove('highlight-flash'), 1000);
            }
        }
        function saveMeasures() {
            if (!app.p.m) app.p.m = {};
            const M = ['shoulder', 'chest', 'neck', 'waist', 'hip', 'arm-l', 'arm-r', 'forearm-l', 'forearm-r', 'thigh-l', 'thigh-r', 'calf-l', 'calf-r'];
            M.forEach(k => {
                const el = document.getElementById('m-' + k);
                if (el) app.p.m[k] = el.value;
            });
            save();
            if (typeof drawStaticGuides === 'function') drawStaticGuides();
        }

        function openRecModal() { st.ri = []; st.rimp = null; document.getElementById('r-ing-box').innerHTML = ''; document.getElementById('r-prev').style.backgroundImage = 'none'; document.getElementById('m-rec').classList.add('open'); }
        function upRI(i) { const f = i.files[0]; if (f) { const r = new FileReader(); r.onload = e => { st.rimp = e.target.result; document.getElementById('r-prev').style.backgroundImage = `url(${st.rimp})`; }; r.readAsDataURL(f); } }
        function pushRI() {
            const id = document.getElementById('r-isel').value, g = parseFloat(document.getElementById('r-iq').value); if (id && g) {
                st.ri.push({ id, g });
                document.getElementById('r-ing-box').innerHTML = st.ri.map(x => `${DB_F.find(y => y.id == x.id).n} (${x.g}g)`).join(', ');
            }
        }
        function saveR() {
            const n = document.getElementById('r-name').value; if (n && st.ri.length) {
                let c = 0; st.ri.forEach(x => c += DB_F.find(y => y.id == x.id).k * (x.g / 100));
                app.r.push({ n, img: st.rimp, ing: st.ri, cal: Math.round(c) }); closeM(); render();
            }
        }
        function delR(i) { app.r.splice(i, 1); render(); }

        let selId = null, uMode = 'g', uSize = 0, isLev = false;

        function parseU(n) {
            const m = n.match(/\((.*?)\)/);
            if (!m) return null;
            const inner = m[1];

            // Check Liter (e.g. 2L -> 2000ml)
            let l_match = inner.match(/([\d\.]+)\s*L/i);
            if (l_match) {
                return { s: parseFloat(l_match[1]) * 1000, n: 'Garrafa', l: true };
            }

            // Normal match
            const num = inner.match(/(\d+)(?:g|ml)/i);
            const type = inner.match(/(Lata|Garrafa|Colher|Fatia|Unidade|Copo|Caixinha|Pacote|Barra|Pote)/i);

            if (num) {
                return { s: parseFloat(num[1]), n: type ? type[1] : 'Unid', l: inner.toLowerCase().includes('ml') };
            }
            return null;
        }

        function setU(m) {
            uMode = m;
            const btns = ['g', 'ml', 'c', 'u'];
            btns.forEach(b => {
                const el = document.getElementById('btn-u-' + b);
                if (el) {
                    el.style.background = 'transparent';
                    el.style.borderColor = 'var(--border)';
                    el.style.color = 'var(--text-med)';
                }
            });

            const act = document.getElementById('btn-u-' + m);
            if (act) {
                act.style.background = 'rgba(50, 215, 75, 0.15)';
                act.style.borderColor = 'var(--primary)';
                act.style.color = 'var(--primary)';
            }

            let pl = 'Qtd', lbl = 'g';
            if (m === 'g') { lbl = 'g'; pl = 'Gramas'; }
            if (m === 'ml') { lbl = 'ml'; pl = 'Mililitros'; }
            if (m === 'c') { lbl = 'cp'; pl = 'Copos (200ml)'; }
            if (m === 'u') { lbl = 'un'; pl = 'Unidades'; }

            document.getElementById('f-unit-lbl').innerText = lbl;
            document.getElementById('f-g').placeholder = pl;

            // Auto-fill logic
            const inp = document.getElementById('f-g');
            const curr = parseFloat(inp.value);
            if ((m === 'u' || m === 'c') && (curr === 100 || curr > 10 || isNaN(curr))) inp.value = 1;
            if ((m === 'g' || m === 'ml') && (curr === 1 || isNaN(curr))) inp.value = (uSize > 0 && uMode === 'ml') ? uSize : 100;
        }



        function toggleFav(id) {
            if (!app.fav) app.fav = [];
            const idx = app.fav.indexOf(id);
            if (idx > -1) {
                app.fav.splice(idx, 1);
            } else {
                app.fav.push(id);
            }
            save();
            renderFList(document.getElementById('f-search').value);
        }

        let listMode = 'all'; // 'all', 'fav', 'rec'

        function toggleListMode(m) {
            if (listMode === m) listMode = 'all';
            else listMode = m;

            // Visual Update
            document.getElementById('btn-mode-fav').classList.toggle('active', listMode === 'fav');
            document.getElementById('btn-mode-rec').classList.toggle('active', listMode === 'rec');

            renderFList(document.getElementById('f-search').value);
        }

        function renderFList(q = '') {
            const list = document.getElementById('f-list');
            if (!list) return;

            let source = [];

            if (listMode === 'rec') {
                // Recents: Use app.rec (IDs) -> Map to Objects -> Preserving Order
                const recIds = app.rec || [];
                // Map and filter out nulls (in case ID removed from DB)
                source = recIds.map(id => DB_F.find(x => x.id == id)).filter(x => x);
            } else if (listMode === 'fav') {
                // Favorites: Filter DB_F (Alphabetical)
                const favIds = app.fav || [];
                source = DB_F.filter(f => favIds.includes(f.id));
            } else {
                // All: DB_F (Alphabetical)
                source = DB_F;
            }

            // Apply Search Filter
            let items = source.filter(f => f.n.toLowerCase().includes(q.toLowerCase()));

            list.innerHTML = items.map(f => {
                const num = DB_F.indexOf(f) + 1; // Strict Global Index
                const isFav = app.fav && app.fav.includes(f.id);
                const starClass = isFav ? 'active' : '';

                return `<div class="food-opt ${selId === f.id ? 'selected' : ''}" onclick="selectFood(${f.id})">
                    <div style="display:flex; align-items:center; flex:1;">
                        <span class="fav-star ${starClass}" onclick="event.stopPropagation(); toggleFav(${f.id})">★</span>
                        <span class="f-opt-name">${f.n}</span>
                    </div>
                    <span class="f-opt-num">#${num}</span>
                </div>`;
            }).join('');
        }


        function selectFood(id) {
            selId = id;
            renderFList(document.getElementById('f-search').value);

            const f = DB_F.find(x => x.id == id);
            const u = parseU(f.n);
            const isBev = /(ml\b|l\b|litro|garrafa|lata|copo|suco|refri|cerveja|chá|café|bebida|drink|dose|iogurte|leite)/i.test(f.n);
            const box = document.getElementById('unit-area');

            /* RESET UI */
            document.getElementById('btn-u-g').style.display = 'block';
            document.getElementById('btn-u-ml').style.display = 'none';
            document.getElementById('btn-u-c').style.display = 'none';
            document.getElementById('btn-u-u').style.display = 'none';
            document.getElementById('u-info').innerText = '';

            let showBox = false;

            if (u) {
                uSize = u.s;
                showBox = true;

                // Package Mode
                const btnU = document.getElementById('btn-u-u');
                btnU.style.display = 'block';
                btnU.innerText = u.n;

                document.getElementById('u-info').innerText = `Ref: ${u.n} = ${u.s}${u.l || isBev ? 'ml' : 'g'}`;

                if (u.l || isBev) {
                    // Beverage Package
                    document.getElementById('btn-u-ml').style.display = 'block';
                    document.getElementById('btn-u-c').style.display = 'block';
                    document.getElementById('btn-u-g').style.display = 'none'; // Hide Grams for Liquids
                    setU('u'); // Default to Unit
                } else {
                    // Solid Package
                    document.getElementById('btn-u-g').innerText = 'g';
                    document.getElementById('btn-u-g').style.display = 'block';
                    setU('u'); // Default to Unit
                }

            } else {
                uSize = 0;
                // No Package, check beverage
                if (isBev) {
                    showBox = true;
                    document.getElementById('btn-u-g').style.display = 'none';
                    document.getElementById('btn-u-ml').style.display = 'block';
                    document.getElementById('btn-u-c').style.display = 'block';
                    document.getElementById('u-info').innerText = 'Base: 100ml';
                    setU('ml');
                } else {
                    // Standard Solid
                    showBox = false;
                    setU('g');
                }
            }

            box.style.display = showBox ? 'block' : 'none';
        }

        function opFM(c) {
            st.ctx = c;
            selId = null;

            // Reset Filter
            listMode = 'all';
            document.getElementById('btn-mode-fav').classList.remove('active');
            document.getElementById('btn-mode-rec').classList.remove('active');

            if (document.getElementById('f-search')) document.getElementById('f-search').value = '';
            renderFList();
            // renderQA(); // Removed
            document.getElementById('m-food').classList.add('open');
            document.getElementById('unit-area').style.display = 'none';
            setU('g');
        }

        function addF() {
            if (!selId) return alert('Selecione um alimento');
            let q = parseFloat(document.getElementById('f-g').value);
            if (!q) return alert('Digite a quantidade');

            let finalG = q;

            // Logic: DB k is for [uSize] if exists, else 100.
            // System expects we store a value X where (X/100 * k) is the energy.

            if (uSize > 0) {
                // IT IS A PACKAGE ITEM (k is for uSize)
                // We need to calculate % of package (0-100 scale)

                let consML = 0;
                if (uMode === 'ml' || uMode === 'g') consML = q;
                if (uMode === 'c') consML = q * 200;
                if (uMode === 'u') consML = q * uSize;

                finalG = (consML / uSize) * 100;

            } else {
                // IT IS A BULK ITEM (k is for 100)
                // We just need raw quantity

                if (uMode === 'c') finalG = q * 200;
                // g/ml is direct
            }

            // ADD TO RECENTS
            if (!app.rec) app.rec = [];
            // Remove if exists to move to top
            app.rec = app.rec.filter(x => x !== selId);
            app.rec.unshift(selId);
            if (app.rec.length > 50) app.rec.pop(); // Max 50

            app.h[st.d][st.ctx].push({ id: selId, g: parseFloat(finalG) });
            closeM();
            render();
        }
        function delF(c, i) { app.h[st.d][c].splice(i, 1); render(); }

        function addWater(v) { if (!app.h[st.d]) app.h[st.d] = { b: [], l: [], d: [], w: 0 }; app.h[st.d].w = (app.h[st.d].w || 0) + v; render(); }
        function manualWater(m) { const v = parseFloat(document.getElementById('w-inp').value); if (v) { addWater(v * m); document.getElementById('w-inp').value = ''; } }

        let selEx = null, eListMode = 'all';

        function openExModal() {
            selEx = null;
            eListMode = 'all';
            document.getElementById('e-search').value = '';
            document.getElementById('e-s').value = '';
            document.getElementById('e-r').value = '';
            document.getElementById('e-kg').value = '';
            document.getElementById('e-sel-display').style.display = 'none';
            document.getElementById('m-ex').classList.add('open');

            // Reset Buttons
            document.getElementById('btn-mode-ex-fav').classList.remove('active');
            document.getElementById('btn-mode-ex-rec').classList.remove('active');

            renderEList();
        }

        function toggleExListMode(m) {
            if (eListMode === m) eListMode = 'all';
            else eListMode = m;

            // Visual Update
            document.getElementById('btn-mode-ex-fav').classList.toggle('active', eListMode === 'fav');
            document.getElementById('btn-mode-ex-rec').classList.toggle('active', eListMode === 'rec');

            renderEList(document.getElementById('e-search').value);
        }

        function toggleExFav(name) {
            if (!app.favE) app.favE = [];
            const idx = app.favE.indexOf(name);
            if (idx > -1) {
                app.favE.splice(idx, 1);
            } else {
                app.favE.push(name);
            }
            save();
            renderEList(document.getElementById('e-search').value);
        }

        function selectEx(name) {
            selEx = name;
            document.getElementById('e-sel-name').innerText = name;
            document.getElementById('e-sel-display').style.display = 'block';
            renderEList(document.getElementById('e-search').value);
        }

        function renderEList(q = '') {
            const container = document.getElementById('e-list');
            if (!container) return;

            // 1. Flatten items for search/filtering, but keep structure for 'all'
            // Actually, best to iterate groups and filter items within groups

            let totalExCount = 0; // Sequential Visual Index

            const groups = Object.keys(DB_E);
            let html = '';

            groups.forEach(g => {
                let items = DB_E[g];

                // Filter by Mode
                if (eListMode === 'fav') {
                    if (!app.favE) app.favE = [];
                    items = items.filter(i => app.favE.includes(i));
                } else if (eListMode === 'rec') {
                    // Recents logic slightly different: recents list dictates order?
                    // User said: "Recente = exercício que o usuário adicionou ou utilizou recentemente"
                    // If mode is REC, we might want to ignore groups and just show the list of recents sorted?
                    // But user said: "Garantir que a lista de exercícios continue organizada por grupos musculares"
                    // However, standard recents view is usually time-sorted.
                    // "Lista dinâmica e automática... mesmo padrão visual dos 'Recentes' das refeições"
                    // Food recents shows a flat list of recent items.
                    // I will replicate Food Recents: Flat list of items in recE.
                    // BUT prompt also says: "Garantir que a lista de exercícios continue organizada por grupos musculares" (Structure final)
                    // The "Structure Final" section lists: "Lista completa de exercícios organizada por grupos musculares".
                    // Maybe Recents should just highlight them?
                    // No, "Botão Recentes" implies a Filter.
                    // If I filter by Recents, I will show only recent items.
                    // Should I group them?
                    // Let's filter items within groups to satisfy "Organizada por grupos".
                    if (!app.recE) app.recE = [];
                    items = items.filter(i => app.recE.includes(i));
                }

                // Filter by Search
                if (q) {
                    items = items.filter(i => i.toLowerCase().includes(q.toLowerCase()));
                }

                if (items.length > 0) {
                    html += `<div style="padding:8px 10px; background:var(--bg-2); font-weight:bold; font-size:0.8rem; color:var(--text-med);">${g}</div>`;

                    items.forEach(i => {
                        totalExCount++;
                        const isFav = app.favE && app.favE.includes(i);
                        const starClass = isFav ? 'active' : '';
                        const isSel = selEx === i;

                        html += `<div class="food-opt ${isSel ? 'selected' : ''}" onclick="selectEx('${i}')" style="cursor:pointer; padding:10px; border-bottom:1px solid var(--border); display:flex; align-items:center;">
                            <span class="fav-star ${starClass}" onclick="event.stopPropagation(); toggleExFav('${i}')" style="font-size:1.2rem; margin-right:10px; color:var(--text-med);">★</span>
                            <span style="flex:1;">${i}</span>
                            <span class="f-opt-num">#${totalExCount}</span>
                        </div>`;
                    });
                }
            });

            // Special Case: Recents Mode Sorted by Time?
            // If eListMode === 'rec', maybe user wants to see them in order?
            // "Lista de exercícios continue organizada por grupos musculares" checks out with filtering items inside groups.
            // I will stick to Grouped View even for Recents to be safe with the "Absolute Rule".

            container.innerHTML = html || '<div style="padding:20px; text-align:center; color:var(--text-med);">Nenhum exercício encontrado.</div>';
        }

        function addEx() {
            if (!selEx) return alert('Selecione um exercício');
            const s = document.getElementById('e-s').value;
            const r = document.getElementById('e-r').value;
            const kg = document.getElementById('e-kg').value; // Added load input

            // Add to Recents
            if (!app.recE) app.recE = [];
            app.recE = app.recE.filter(x => x !== selEx);
            app.recE.unshift(selEx);
            if (app.recE.length > 50) app.recE.pop();

            // Format Name with Load if provided
            let finalName = selEx;
            if (kg) finalName += ` (${kg}kg)`;

            app.w[st.day].push({ n: finalName, s, r });
            closeM();
            render();
        }

        // A chamada init() será feita no bloco de inicialização no final do script
        function delE(i) { app.w[st.day].splice(i, 1); render(); }

        function go(v) {
            st.v = v;
            // Update Tab Bar
            document.querySelectorAll('.nav-it').forEach(e => e.classList.remove('active'));
            const m = { 'diary': 0, 'recipes': 1, 'workout': 2, 'profile': 3 };
            document.querySelectorAll('.nav-it')[m[v]].classList.add('active');

            // Update View Visibility
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');

            render();
        }
        function closeM() { document.querySelectorAll('.modal').forEach(e => e.classList.remove('open')); }
        window.addEventListener('scroll', () => {
            const h = document.querySelector('header');
            if (window.scrollY > 10) {
                h.classList.add('scrolled');
            } else {
                h.classList.remove('scrolled');
            }
        });

        function save() { localStorage.setItem('nutriV7', JSON.stringify(app)); }


        // Estado da visão do corpo
        let currentBodyView = 'front';

        // Preloader
        // Proteção para evitar travamento se as constantes de imagem faltarem
        // Use Base64 for generic/male if available to ensure loading
        const IMG_BODY_FRONT_M = (typeof IMG_BODY_FRONT !== 'undefined') ? IMG_BODY_FRONT : 'assets/body_front.png';
        const IMG_BODY_BACK_M = (typeof IMG_BODY_BACK !== 'undefined') ? IMG_BODY_BACK : 'assets/body_back.png';
        const IMG_BODY_FEMALE_FRONT = "assets/body_female_front.png";
        const IMG_BODY_FEMALE_BACK = "assets/body_female_back.png";

        try {
            const preloadBackM = new Image(); preloadBackM.src = IMG_BODY_BACK_M;
            const preloadFrontF = new Image(); preloadFrontF.src = IMG_BODY_FEMALE_FRONT;
            const preloadBackF = new Image(); preloadBackF.src = IMG_BODY_FEMALE_BACK;
        } catch (e) {
            console.warn("Image Preload Error:", e);
        }

        function setBodyView(view) {
            const imgEl = document.getElementById('body-anatomy-img');
            if (!imgEl) return;

            currentBodyView = view;
            const sex = (app.p && app.p.sex) ? app.p.sex : 'm';

            try {
                if (sex === 'f') {
                    if (view === 'front') {
                        // Show image for female front view
                        imgEl.style.display = 'block';
                        imgEl.src = IMG_BODY_FEMALE_FRONT;
                    } else {
                        // Show image for female back view
                        imgEl.style.display = 'block';
                        imgEl.src = IMG_BODY_FEMALE_BACK;
                    }
                } else {
                    // Male logic
                    imgEl.style.display = 'block';
                    if (view === 'back') {
                        imgEl.src = IMG_BODY_BACK_M;
                    } else {
                        imgEl.src = IMG_BODY_FRONT_M;
                    }
                }

                if (typeof drawStaticGuides === 'function') drawStaticGuides();
            } catch (e) {
                console.error("SetBodyView Error:", e);
            }
        }

        function toggleBodyView() {
            if (currentBodyView === 'front') {
                setBodyView('back');
            } else {
                setBodyView('front');
            }
        }

        const guideMappingM = {
            'm-neck': { y: 65, view: 'front', x1: 65, x2: 95, side: 'both' },
            'm-shoulder': { y: 88, view: 'front', x1: 30, x2: 130, side: 'both' },
            'm-chest': { y: 115, view: 'front', x1: 20, x2: 140, side: 'both' },
            'm-arm-l': { y: 145, view: 'front', x1: 15, x2: 50, side: 'l' },
            'm-arm-r': { y: 145, view: 'front', x1: 110, x2: 145, side: 'r' },
            'm-forearm-l': { y: 195, view: 'front', x1: 10, x2: 40, side: 'l' },
            'm-forearm-r': { y: 195, view: 'front', x1: 120, x2: 150, side: 'r' },
            'm-waist': { y: 165, view: 'front', x1: 58, x2: 102, side: 'both' },
            'm-hip': { y: 205, view: 'back', x1: 45, x2: 115, side: 'both' },
            'm-thigh-l': { y: 270, view: 'front', x1: 40, x2: 75, side: 'l' },
            'm-thigh-r': { y: 270, view: 'front', x1: 85, x2: 120, side: 'r' },
            'm-calf-l': { y: 345, view: 'back', x1: 50, x2: 75, side: 'l' },
            'm-calf-r': { y: 345, view: 'back', x1: 85, x2: 110, side: 'r' },
            'm-weight': { y: -10, view: 'front', x1: 0, x2: 160, side: 'both' }
        };

        const guideMappingF = {
            'm-neck': { y: 65, view: 'front', x1: 65, x2: 95, side: 'both' },
            'm-shoulder': { y: 88, view: 'front', x1: 30, x2: 130, side: 'both' },
            // Chest adjusted? Keeping generally same for safely init
            'm-chest': { y: 115, view: 'front', x1: 20, x2: 140, side: 'both' },
            'm-arm-l': { y: 145, view: 'front', x1: 15, x2: 50, side: 'l' },
            'm-arm-r': { y: 145, view: 'front', x1: 110, x2: 145, side: 'r' },
            'm-forearm-l': { y: 195, view: 'front', x1: 10, x2: 40, side: 'l' },
            'm-forearm-r': { y: 195, view: 'front', x1: 120, x2: 150, side: 'r' },
            // Waist usually higher/narrower
            'm-waist': { y: 165, view: 'front', x1: 58, x2: 102, side: 'both' },
            'm-hip': { y: 205, view: 'back', x1: 45, x2: 115, side: 'both' },
            'm-thigh-l': { y: 270, view: 'front', x1: 40, x2: 75, side: 'l' },
            'm-thigh-r': { y: 270, view: 'front', x1: 85, x2: 120, side: 'r' },
            'm-calf-l': { y: 345, view: 'back', x1: 50, x2: 75, side: 'l' },
            'm-calf-r': { y: 345, view: 'back', x1: 85, x2: 110, side: 'r' },
            'm-weight': { y: -10, view: 'front', x1: 0, x2: 160, side: 'both' }
        };

        function getGuideMapping() {
            const sex = (app.p && app.p.sex) ? app.p.sex : 'm';
            return (sex === 'f') ? guideMappingF : guideMappingM;
        }

        function showGuide(inputId) {
            const mapping = getGuideMapping();
            const config = mapping[inputId];
            if (!config) return;
            if (config.view !== currentBodyView) setBodyView(config.view);
            const svg = document.getElementById('body-guide-svg');
            const line = document.getElementById('guide-line-obj');
            const circleL = document.getElementById('guide-circle-left');
            const circleR = document.getElementById('guide-circle-right');

            if (config.y < 0) { if (svg) svg.classList.remove('guide-active'); return; }

            if (line) {
                line.setAttribute('y1', config.y);
                line.setAttribute('y2', config.y);
                line.setAttribute('x1', config.x1 || 0);
                line.setAttribute('x2', config.x2 || 160);
            }
            if (circleL) {
                circleL.setAttribute('cy', config.y);
                circleL.setAttribute('cx', config.x1 || 10);
                circleL.style.display = (config.side === 'l' || config.side === 'both') ? 'block' : 'none';
            }
            if (circleR) {
                circleR.setAttribute('cy', config.y);
                circleR.setAttribute('cx', config.x2 || 150);
                circleR.style.display = (config.side === 'r' || config.side === 'both') ? 'block' : 'none';
            }

            if (svg) svg.classList.add('guide-active');
        }

        function hideGuide() {
            const svg = document.getElementById('body-guide-svg');
            if (svg) svg.classList.remove('guide-active');
        }

        function drawStaticGuides() {
            const container = document.getElementById('static-guides-container');
            if (!container) return;
            container.innerHTML = '';

            if (!app.p || !app.p.m) return;

            const mapping = getGuideMapping();
            Object.keys(mapping).forEach(key => {
                const pureKey = key.replace('m-', '');
                const val = app.p.m[pureKey] || app.p.m[pureKey.replace('-', '')];
                if (val && parseFloat(val) > 0) {
                    const config = mapping[key];
                    if (config && config.view === currentBodyView && config.y >= 0) {
                        // Drawing Line
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", config.x1 || 0);
                        line.setAttribute("y1", config.y);
                        line.setAttribute("x2", config.x2 || 160);
                        line.setAttribute("y2", config.y);
                        line.setAttribute("class", "guide-line-static");
                        container.appendChild(line);

                        // Drawing Circles (Symmetric to active guide)
                        if (config.side === 'l' || config.side === 'both') {
                            const c1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            c1.setAttribute("cx", config.x1 || 10);
                            c1.setAttribute("cy", config.y);
                            c1.setAttribute("r", "2");
                            c1.setAttribute("class", "guide-circle-static");
                            container.appendChild(c1);
                        }

                        if (config.side === 'r' || config.side === 'both') {
                            const c2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            c2.setAttribute("cx", config.x2 || 150);
                            c2.setAttribute("cy", config.y);
                            c2.setAttribute("r", "2");
                            c2.setAttribute("class", "guide-circle-static");
                            container.appendChild(c2);
                        }
                    }
                }
            });
            console.log("NutriApp: Static guides rendered for view:", currentBodyView);
        }


        // Initialize App
        try {
            init();
        } catch (e) {
            console.error("Critical Init Error:", e);
        } finally {
            // Ensure UI is rendered even if init fails
            try { render(); } catch (e2) { console.error("Render Fallback Error:", e2); }
        }
    </script>
</body>

</html>